<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sports Island | 運動課程預約</title>
    
    <!-- LINE LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            color: #000000;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #000000;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: #ffffff;
            border-top: 1px solid #e5e7eb;
            display: flex;
            z-index: 100;
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #000000;
            opacity: 0.5;
            text-decoration: none;
            transition: opacity 0.2s;
        }
        
        .nav-item.active {
            opacity: 1;
        }
        
        /* 去框化樣式 */
        .card {
            border: none !important;
            box-shadow: none !important;
            border-radius: 0 !important;
        }
        
        .text-emphasis {
            color: #000000 !important;
            font-weight: 900 !important;
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen pb-16">
        <!-- 導航欄 -->
        <header class="sticky top-0 bg-white border-b border-gray-100 z-10">
            <div class="px-4 py-3">
                <h1 class="text-lg font-black text-black">SPORTS ISLAND</h1>
            </div>
        </header>
        
        <!-- 主要內容 -->
        <main id="content" class="p-4">
            <div id="loading" class="flex flex-col items-center justify-center min-h-[60vh]">
                <div class="loading mb-4"></div>
                <p class="text-black font-medium">正在初始化系統...</p>
            </div>
            
            <div id="main-content" class="hidden">
                <!-- 內容會動態載入到這裡 -->
            </div>
        </main>
        
        <!-- 底部導航 -->
        <div class="bottom-nav">
            <a href="#home" class="nav-item active" data-view="home">
                <i data-lucide="home"></i>
                <span>課程</span>
            </a>
            <a href="#history" class="nav-item" data-view="history">
                <i data-lucide="history"></i>
                <span>紀錄</span>
            </a>
            <a href="#profile" class="nav-item" data-view="profile">
                <i data-lucide="user"></i>
                <span>會員</span>
            </a>
        </div>
        
        <!-- 彈出視窗 -->
        <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-md">
                <div class="p-6">
                    <h3 id="modal-title" class="text-lg font-black text-black mb-2"></h3>
                    <p id="modal-message" class="text-black mb-6"></p>
                    <button id="modal-ok" class="w-full py-3 bg-black text-white font-black">確定</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 配置
        const CONFIG = {
            LIFF_ID: '2008786875-F7ifLsbN',
            API_BASE_URL: 'https://aged-rice-2438.wetw-net3.workers.dev' // 您的 Cloudflare Worker
        };
        
        // 全局變數
        let userId = null;
        let userProfile = null;
        let currentView = 'home';
        
        // 顯示訊息
        function showMessage(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal').classList.remove('hidden');
        }
        
        // 關閉訊息
        document.getElementById('modal-ok').addEventListener('click', function() {
            document.getElementById('modal').classList.add('hidden');
        });
        
        // 初始化 LIFF
        async function initializeLIFF() {
            try {
                console.log('正在初始化 LIFF...');
                
                await liff.init({
                    liffId: CONFIG.LIFF_ID,
                    withLoginOnExternalBrowser: true
                });
                
                console.log('LIFF 初始化成功');
                
                if (!liff.isLoggedIn()) {
                    console.log('用戶未登入，執行登入...');
                    liff.login();
                    return false;
                }
                
                userProfile = await liff.getProfile();
                userId = userProfile.userId;
                
                console.log('用戶資料:', userProfile);
                console.log('用戶ID:', userId);
                
                localStorage.setItem('sportflow_user_id', userId);
                localStorage.setItem('user_name', userProfile.displayName);
                
                return true;
                
            } catch (error) {
                console.error('LIFF 初始化失敗:', error);
                showMessage('初始化失敗', '請重新整理頁面');
                return false;
            }
        }
        
        // API 服務
        class ApiService {
            constructor() {
                this.baseUrl = CONFIG.API_BASE_URL;
            }
            
            setUserId(id) {
                userId = id;
            }
            
            async request(endpoint, data = {}) {
                try {
                    console.log(`API 請求: ${endpoint}`, data);
                    
                    const response = await fetch(`${this.baseUrl}${endpoint}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'User-Id': userId || ''
                        },
                        body: JSON.stringify(data)
                    });
                    
                    console.log(`API 回應狀態: ${response.status}`);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API 錯誤回應:', errorText);
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    console.log('API 回應:', result);
                    
                    if (!result.success) {
                        throw new Error(result.error?.message || result.error || 'API 請求失敗');
                    }
                    
                    return result.data;
                    
                } catch (error) {
                    console.error('API 請求失敗:', error);
                    throw error;
                }
            }
            
            async healthCheck() {
                try {
                    const response = await fetch(`${this.baseUrl}/health`);
                    return response.ok;
                } catch {
                    return false;
                }
            }
            
            async getCourses() {
                return this.request('', { action: 'getCourses' });
            }
            
            async getCourse(courseId) {
                return this.request('', { action: 'getCourse', courseId });
            }
            
            async getUser() {
                return this.request('', { action: 'getUser' });
            }
            
            async checkRegistration() {
                return this.request('', { action: 'checkRegistration' });
            }
            
            async updateUser(userData) {
                return this.request('', { action: 'updateUser', userData });
            }
        }
        
        // 創建 API 實例
        const api = new ApiService();
        
        // 渲染課程卡片
        function renderCourseCard(course) {
            const isEarlyBird = course.是否早鳥;
            const isFull = course.是否額滿;
            
            return `
                <div class="course-card border-b border-gray-100 last:border-b-0 pb-4 mb-4">
                    <div class="mb-3">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-base font-black text-black flex-1 pr-2">${course.課程名稱}</h3>
                            <span class="text-xs font-black ${isFull ? 'text-red-600' : 'text-green-600'}">
                                ${isFull ? '額滿' : `${course.剩餘名額 || course.招生名額} 名額`}
                            </span>
                        </div>
                        
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-xs font-black text-black bg-yellow-100 px-2 py-1">
                                ${course.要求等級}
                            </span>
                            <span class="text-xs font-black text-black">
                                ${course.教練名稱}
                            </span>
                        </div>
                    </div>
                    
                    <div class="space-y-2 mb-3">
                        <div class="flex items-center text-sm">
                            <i data-lucide="calendar" class="w-4 h-4 text-black mr-2"></i>
                            <span class="font-black text-black">${course.活動日期} ${course.活動時段}</span>
                        </div>
                        <div class="flex items-center text-sm">
                            <i data-lucide="map-pin" class="w-4 h-4 text-black mr-2"></i>
                            <span class="font-black text-black">${course.活動地點}</span>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center pt-3 border-t border-gray-100">
                        <div>
                            ${isEarlyBird && course.早鳥价 ? `
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-gray-500 line-through">${course.原價} PT</span>
                                <span class="text-lg font-black text-red-600">${course.早鳥价} PT</span>
                            </div>
                            ` : `
                            <span class="text-lg font-black text-black">${course.原價} PT</span>
                            `}
                        </div>
                        
                        <button class="btn-detail px-4 py-2 bg-black text-white text-sm font-black"
                                data-course-id="${course.UUID}">
                            詳細說明
                        </button>
                    </div>
                </div>
            `;
        }
        
        // 渲染首頁
        async function renderHomeView() {
            try {
                const data = await api.getCourses();
                const courses = data?.courses || [];
                
                if (courses.length === 0) {
                    return `
                        <div class="text-center py-12">
                            <div class="text-gray-300 mb-4">
                                <i data-lucide="calendar" class="w-16 h-16 mx-auto"></i>
                            </div>
                            <h3 class="text-lg font-black text-black mb-2">暫無課程</h3>
                            <p class="text-gray-600">目前沒有可預約的課程</p>
                        </div>
                    `;
                }
                
                let html = `
                    <div class="mb-6">
                        <h2 class="text-xl font-black text-black mb-2">可預約課程</h2>
                        <p class="text-sm text-gray-600">共 ${courses.length} 個課程</p>
                    </div>
                    
                    <div class="space-y-4">
                `;
                
                courses.forEach(course => {
                    html += renderCourseCard(course);
                });
                
                html += '</div>';
                
                return html;
                
            } catch (error) {
                console.error('載入課程失敗:', error);
                return `
                    <div class="text-center py-12">
                        <div class="text-red-600 mb-4">
                            <i data-lucide="alert-circle" class="w-16 h-16 mx-auto"></i>
                        </div>
                        <h3 class="text-lg font-black text-black mb-2">載入失敗</h3>
                        <p class="text-gray-600 mb-4">無法載入課程資訊</p>
                        <button onclick="loadHomeView()" class="px-4 py-2 bg-black text-white font-black">
                            重新載入
                        </button>
                    </div>
                `;
            }
        }
        
        // 載入首頁
        async function loadHomeView() {
            const content = document.getElementById('main-content');
            content.innerHTML = `
                <div class="flex items-center justify-center py-12">
                    <div class="loading"></div>
                </div>
            `;
            
            const html = await renderHomeView();
            content.innerHTML = html;
            
            lucide.createIcons();
            
            // 綁定事件
            document.querySelectorAll('.btn-detail').forEach(button => {
                button.addEventListener('click', async function() {
                    const courseId = this.dataset.courseId;
                    try {
                        const data = await api.getCourse(courseId);
                        const course = data?.course;
                        if (course) {
                            showMessage(course.課程名稱, course.文字簡介);
                        }
                    } catch (error) {
                        showMessage('錯誤', '無法載入課程詳情');
                    }
                });
            });
        }
        
        // 載入會員頁面
        async function loadProfileView() {
            try {
                const data = await api.getUser();
                const user = data?.user || {};
                const userName = localStorage.getItem('user_name') || user.學員姓名 || '使用者';
                
                // 檢查必填欄位
                const requiredFields = ['家長姓名', '聯繫電話', '學員姓名', '性別', '生日', '目前年級'];
                const missingFields = requiredFields.filter(field => !user[field]);
                
                return `
                    <div class="py-6">
                        <div class="mb-6">
                            <h2 class="text-xl font-black text-black mb-2">會員專區</h2>
                            <p class="text-sm text-gray-600">管理您的個人資料和預約</p>
                        </div>
                        
                        ${missingFields.length > 0 ? `
                        <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-6">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <i data-lucide="alert-triangle" class="w-5 h-5 text-yellow-500"></i>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm text-yellow-800">
                                        請完善以下資料以進行預約：${missingFields.join(', ')}
                                    </p>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="bg-gray-50 p-4 mb-6">
                            <div class="flex items-center mb-4">
                                <div class="w-12 h-12 bg-black rounded-full flex items-center justify-center text-white font-black mr-3">
                                    ${userName.charAt(0)}
                                </div>
                                <div>
                                    <h3 class="text-base font-black text-black">${userName}</h3>
                                    <p class="text-sm text-gray-600">LINE: ${userProfile?.displayName || ''}</p>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <div class="text-xs font-black text-gray-600 mb-1">家長姓名</div>
                                    <div class="text-sm font-black text-black">${user.家長姓名 || '未填寫'}</div>
                                </div>
                                <div>
                                    <div class="text-xs font-black text-gray-600 mb-1">聯繫電話</div>
                                    <div class="text-sm font-black text-black">${user.聯繫電話 || '未填寫'}</div>
                                </div>
                                <div>
                                    <div class="text-xs font-black text-gray-600 mb-1">學員姓名</div>
                                    <div class="text-sm font-black text-black">${user.學員姓名 || '未填寫'}</div>
                                </div>
                                <div>
                                    <div class="text-xs font-black text-gray-600 mb-1">性別</div>
                                    <div class="text-sm font-black text-black">${user.性別 || '未填寫'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="border-b border-gray-100 pb-4">
                                <h4 class="text-base font-black text-black mb-2">點數餘額</h4>
                                <div class="flex items-center justify-between">
                                    <span class="text-2xl font-black text-black">${user.點數餘額 || 0} PT</span>
                                    <button class="px-4 py-2 bg-black text-white text-sm font-black">
                                        購買點數
                                    </button>
                                </div>
                            </div>
                            
                            <div>
                                <button onclick="showEditProfile()" class="w-full py-3 border border-gray-300 text-black font-black mb-3">
                                    編輯資料
                                </button>
                                <button onclick="localStorage.clear(); liff.logout();" 
                                        class="w-full py-3 border border-gray-300 text-black font-black">
                                    登出
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('載入會員資料失敗:', error);
                return `
                    <div class="text-center py-12">
                        <div class="text-red-600 mb-4">
                            <i data-lucide="alert-circle" class="w-16 h-16 mx-auto"></i>
                        </div>
                        <h3 class="text-lg font-black text-black mb-2">載入失敗</h3>
                        <p class="text-gray-600">無法載入會員資料</p>
                    </div>
                `;
            }
        }
        
        // 載入紀錄頁面
        async function loadHistoryView() {
            return `
                <div class="py-6">
                    <div class="mb-6">
                        <h2 class="text-xl font-black text-black mb-2">預約紀錄</h2>
                        <p class="text-sm text-gray-600">查看您的課程預約歷史</p>
                    </div>
                    
                    <div class="text-center py-12">
                        <div class="text-gray-300 mb-4">
                            <i data-lucide="history" class="w-16 h-16 mx-auto"></i>
                        </div>
                        <h3 class="text-lg font-black text-black mb-2">暫無預約紀錄</h3>
                        <p class="text-gray-600">您還沒有預約過任何課程</p>
                        <button onclick="loadView('home')" class="mt-4 px-4 py-2 bg-black text-white font-black">
                            瀏覽課程
                        </button>
                    </div>
                </div>
            `;
        }
        
        // 編輯資料表單
        function showEditProfile() {
            const form = `
                <div class="py-6">
                    <div class="mb-6">
                        <h2 class="text-xl font-black text-black mb-2">編輯會員資料</h2>
                        <p class="text-sm text-gray-600">請填寫以下必要資料</p>
                    </div>
                    
                    <form id="edit-form" class="space-y-4">
                        <div>
                            <label class="block text-xs font-black text-black mb-2">家長姓名 *</label>
                            <input type="text" name="家長姓名" required 
                                   class="w-full px-3 py-2 border-b-2 border-black bg-gray-50">
                        </div>
                        <div>
                            <label class="block text-xs font-black text-black mb-2">聯繫電話 *</label>
                            <input type="tel" name="聯繫電話" required pattern="09[0-9]{8}"
                                   class="w-full px-3 py-2 border-b-2 border-black bg-gray-50" 
                                   placeholder="0912345678">
                        </div>
                        <div>
                            <label class="block text-xs font-black text-black mb-2">學員姓名 *</label>
                            <input type="text" name="學員姓名" required
                                   class="w-full px-3 py-2 border-b-2 border-black bg-gray-50">
                        </div>
                        <div>
                            <label class="block text-xs font-black text-black mb-2">性別 *</label>
                            <select name="性別" required class="w-full px-3 py-2 border-b-2 border-black bg-gray-50">
                                <option value="">請選擇</option>
                                <option value="男">男</option>
                                <option value="女">女</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-black text-black mb-2">生日 *</label>
                            <input type="date" name="生日" required
                                   class="w-full px-3 py-2 border-b-2 border-black bg-gray-50">
                        </div>
                        <div>
                            <label class="block text-xs font-black text-black mb-2">就讀學校</label>
                            <input type="text" name="就讀學校"
                                   class="w-full px-3 py-2 border-b-2 border-black bg-gray-50">
                        </div>
                        <div>
                            <label class="block text-xs font-black text-black mb-2">目前年級 *</label>
                            <select name="目前年級" required class="w-full px-3 py-2 border-b-2 border-black bg-gray-50">
                                <option value="">請選擇</option>
                                <option value="幼兒">幼兒</option>
                                <option value="低">低年級</option>
                                <option value="中">中年級</option>
                                <option value="高">高年級</option>
                                <option value="國高中">國高中</option>
                                <option value="成人">成人</option>
                            </select>
                        </div>
                        
                        <div class="pt-4">
                            <button type="submit" class="w-full py-3 bg-black text-white font-black">
                                儲存資料
                            </button>
                            <button type="button" onclick="loadView('profile')" 
                                    class="w-full py-3 border border-gray-300 text-black font-black mt-3">
                                取消
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = form;
            
            // 綁定表單提交事件
            document.getElementById('edit-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const userData = {};
                formData.forEach((value, key) => {
                    userData[key] = value;
                });
                
                try {
                    await api.updateUser(userData);
                    showMessage('成功', '資料已更新');
                    setTimeout(() => loadView('profile'), 1500);
                } catch (error) {
                    showMessage('錯誤', '更新失敗，請稍後再試');
                }
            });
        }
        
        // 載入視圖
        async function loadView(view) {
            currentView = view;
            const content = document.getElementById('main-content');
            
            // 更新導航狀態
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.view === view) {
                    item.classList.add('active');
                }
            });
            
            content.innerHTML = `
                <div class="flex items-center justify-center py-12">
                    <div class="loading"></div>
                </div>
            `;
            
            let html = '';
            
            switch (view) {
                case 'home':
                    html = await renderHomeView();
                    break;
                case 'profile':
                    html = await loadProfileView();
                    break;
                case 'history':
                    html = await loadHistoryView();
                    break;
                default:
                    html = '<div class="p-8 text-center"><p class="text-black">找不到頁面</p></div>';
            }
            
            content.innerHTML = html;
            lucide.createIcons();
        }
        
        // 主初始化函數
        async function initializeApp() {
            try {
                console.log('開始初始化應用...');
                
                // 初始化 LIFF
                const liffSuccess = await initializeLIFF();
                if (!liffSuccess) return;
                
                // 設置 API 用戶 ID
                api.setUserId(userId);
                
                // 檢查註冊狀態
                try {
                    const regData = await api.checkRegistration();
                    if (!regData?.isRegistered) {
                        setTimeout(() => {
                            showMessage('請完善資料', '請先填寫基本資料以進行課程預約');
                        }, 1000);
                    }
                } catch (regError) {
                    console.log('檢查註冊狀態失敗，繼續載入');
                }
                
                // 隱藏載入畫面
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                
                // 載入首頁
                await loadView('home');
                
                console.log('應用初始化完成');
                
            } catch (error) {
                console.error('應用初始化失敗:', error);
                
                document.getElementById('loading').innerHTML = `
                    <div class="text-center">
                        <div class="text-red-600 mb-4">
                            <i data-lucide="alert-circle" class="w-16 h-16"></i>
                        </div>
                        <h3 class="text-lg font-black text-black mb-2">發生錯誤</h3>
                        <p class="text-gray-600 mb-4">${error.message}</p>
                        <button onclick="location.reload()" class="px-4 py-2 bg-black text-white font-black">
                            重新整理
                        </button>
                    </div>
                `;
            }
        }
        
        // 綁定導航事件
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const view = this.dataset.view;
                    loadView(view);
                });
            });
            
            if (typeof liff !== 'undefined') {
                initializeApp();
            } else {
                setTimeout(() => {
                    if (typeof liff === 'undefined') {
                        showMessage('錯誤', 'LINE SDK 載入失敗');
                    }
                }, 3000);
            }
        });
        
        // 導出函數
        window.loadView = loadView;
        window.showEditProfile = showEditProfile;
    </script>
</body>
</html>
