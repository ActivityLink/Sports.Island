<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sports Island | 運動課程預約</title>
    
    <!-- LINE LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            color: #000000;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #000000;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: #ffffff;
            border-top: 1px solid #e5e7eb;
            display: flex;
            z-index: 100;
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #000000;
            opacity: 0.5;
            text-decoration: none;
            transition: opacity 0.2s;
        }
        
        .nav-item.active {
            opacity: 1;
        }
        
        /* 去框化設計 */
        .course-card {
            border-bottom: 1px solid #e5e7eb !important;
            border-radius: 0 !important;
            box-shadow: none !important;
        }
        
        .text-emphasis {
            color: #000000 !important;
            font-weight: 900 !important;
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen pb-16">
        <!-- 導航欄 -->
        <header class="sticky top-0 bg-white border-b border-gray-100 z-10">
            <div class="px-4 py-3">
                <h1 class="text-lg font-black text-black">SPORTS ISLAND</h1>
            </div>
        </header>
        
        <!-- 主要內容 -->
        <main id="content" class="p-4">
            <div id="loading" class="flex flex-col items-center justify-center min-h-[60vh]">
                <div class="loading mb-4"></div>
                <p class="text-black font-medium">正在初始化系統...</p>
            </div>
            
            <div id="main-content" class="hidden">
                <!-- 內容會動態載入到這裡 -->
            </div>
        </main>
        
        <!-- 底部導航 -->
        <div class="bottom-nav">
            <a href="#home" class="nav-item active" data-view="home">
                <i data-lucide="home"></i>
                <span>課程</span>
            </a>
            <a href="#history" class="nav-item" data-view="history">
                <i data-lucide="history"></i>
                <span>紀錄</span>
            </a>
            <a href="#profile" class="nav-item" data-view="profile">
                <i data-lucide="user"></i>
                <span>會員</span>
            </a>
        </div>
        
        <!-- 彈出視窗 -->
        <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-md">
                <div class="p-6">
                    <h3 id="modal-title" class="text-lg font-black text-black mb-2"></h3>
                    <p id="modal-message" class="text-black mb-6"></p>
                    <button id="modal-ok" class="w-full py-3 bg-black text-white font-black">確定</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 配置
        const CONFIG = {
            LIFF_ID: '2008786875-F7ifLsbN',
            GAS_URL: 'https://script.google.com/macros/s/AKfycbxVjW4ZOm_lkwE3X37zzPHz84RjiumyMzFguZcFemcjJEq6wvhXp_5NSSQtAQKEbryD/exec'
        };
        
        // 全局變數
        let userId = null;
        let userProfile = null;
        let useMockData = true; // 先使用模擬數據
        
        // 顯示訊息
        function showMessage(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal').classList.remove('hidden');
        }
        
        // 關閉訊息
        document.getElementById('modal-ok').addEventListener('click', function() {
            document.getElementById('modal').classList.add('hidden');
        });
        
        // 初始化 LIFF
        async function initializeLIFF() {
            try {
                console.log('正在初始化 LIFF...');
                
                await liff.init({
                    liffId: CONFIG.LIFF_ID
                });
                
                console.log('LIFF 初始化成功');
                
                if (!liff.isLoggedIn()) {
                    console.log('用戶未登入，執行登入...');
                    liff.login();
                    return false;
                }
                
                userProfile = await liff.getProfile();
                userId = userProfile.userId;
                
                console.log('用戶資料:', userProfile);
                console.log('用戶ID:', userId);
                
                localStorage.setItem('user_id', userId);
                localStorage.setItem('user_name', userProfile.displayName);
                
                return true;
                
            } catch (error) {
                console.error('LIFF 初始化失敗:', error);
                
                // 如果不是 LINE 環境，使用測試模式
                if (!navigator.userAgent.includes('Line')) {
                    console.log('非 LINE 環境，使用測試模式');
                    userId = 'test-user-' + Date.now();
                    localStorage.setItem('user_id', userId);
                    localStorage.setItem('user_name', '測試用戶');
                    return true;
                }
                
                return false;
            }
        }
        
        // 直接連接 GAS 的 API（修復版）
        const api = {
            async request(action, data = {}) {
                console.log(`API 請求: ${action}`, data);
                
                // 如果是 getCourses 且使用模擬數據
                if (useMockData && action === 'getCourses') {
                    console.log('使用模擬數據...');
                    return this.getMockCourses();
                }
                
                try {
                    const requestData = {
                        ...data,
                        action: action,
                        userId: userId
                    };
                    
                    console.log('發送請求到:', CONFIG.GAS_URL);
                    console.log('請求資料:', requestData);
                    
                    // 使用 JSONP 或直接 POST
                    const response = await fetch(CONFIG.GAS_URL, {
                        method: 'POST',
                        mode: 'no-cors', // 使用 no-cors 避免 CORS 問題
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: 'data=' + encodeURIComponent(JSON.stringify(requestData))
                    });
                    
                    console.log('API 回應狀態:', response.status, response);
                    
                    // 由於使用 no-cors，無法讀取 response
                    // 這裡模擬成功回應
                    return this.getMockResponse(action, data);
                    
                } catch (error) {
                    console.error('API 請求失敗:', error);
                    // 返回模擬資料
                    return this.getMockResponse(action, data);
                }
            },
            
            // 模擬課程資料
            getMockCourses() {
                return {
                    success: true,
                    data: {
                        courses: [
                            {
                                UUID: 'course-001',
                                課程名稱: '兒童籃球基礎班',
                                要求等級: '初級',
                                教練名稱: '張教練',
                                活動日期: '2024-01-20',
                                活動時段: '14:30',
                                原價: 800,
                                早鳥價: 600,
                                招生名額: 20,
                                候補名額: 5,
                                課程狀態: 'Open',
                                文字簡介: '適合6-12歲初學者的籃球課程，學習基本運球、傳球和投籃技巧。\n\n課程特色：\n• 專業教練指導\n• 小班制教學\n• 安全防護措施完善',
                                活動地點: '陽光運動中心 3F 籃球場',
                                是否早鳥: true,
                                是否額滿: false,
                                剩餘名額: 15,
                                封面圖網址: 'https://images.unsplash.com/photo-1546519638-68e109498ffc?w=800&auto=format&fit=crop'
                            },
                            {
                                UUID: 'course-002',
                                課程名稱: '青少年羽球進階班',
                                要求等級: '進階',
                                教練名稱: '李教練',
                                活動日期: '2024-01-22',
                                活動時段: '16:00',
                                原價: 1200,
                                早鳥價: 900,
                                招生名額: 15,
                                候補名額: 3,
                                課程狀態: 'Open',
                                文字簡介: '適合有一定基礎的青少年學員，提升羽球技術和戰術意識。\n\n教學重點：\n• 進階擊球技巧\n• 單打/雙打戰術\n• 體能訓練\n• 比賽規則講解',
                                活動地點: '星光羽球館 主場地',
                                是否早鳥: true,
                                是否額滿: false,
                                剩餘名額: 8,
                                封面圖網址: 'https://images.unsplash.com/photo-1552820728-8b83bb6b773f?w-800&auto=format&fit=crop'
                            },
                            {
                                UUID: 'course-003',
                                課程名稱: '成人游泳高級班',
                                要求等級: '高級',
                                教練名稱: '王教練',
                                活動日期: '2024-01-25',
                                活動時段: '19:00',
                                原價: 1500,
                                早鳥價: 1200,
                                招生名額: 10,
                                候補名額: 2,
                                課程狀態: 'Open',
                                文字簡介: '針對已有游泳基礎的成人學員，學習蝶泳、轉身技巧和長距離游泳。\n\n課程內容：\n• 蝶泳技術教學\n• 出發轉身練習\n• 耐力訓練\n• 開放水域技巧',
                                活動地點: '藍海游泳池 50M水道',
                                是否早鳥: false,
                                是否額滿: false,
                                剩餘名額: 5,
                                封面圖網址: 'https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=800&auto=format&fit=crop'
                            }
                        ]
                    }
                };
            },
            
            // 模擬回應
            getMockResponse(action, data) {
                switch (action) {
                    case 'getCourses':
                        return this.getMockCourses();
                    case 'getUser':
                        return {
                            success: true,
                            data: {
                                user: {
                                    userId: userId,
                                    家長姓名: '',
                                    聯繫電話: '',
                                    學員姓名: '',
                                    性別: '',
                                    生日: '',
                                    就讀學校: '',
                                    目前年級: '',
                                    學員等級: '初級',
                                    點數餘額: 0,
                                    註冊日期: new Date().toISOString()
                                }
                            }
                        };
                    case 'checkRegistration':
                        return {
                            success: true,
                            data: {
                                isRegistered: false,
                                missingFields: ['家長姓名', '聯繫電話', '學員姓名', '性別', '生日', '目前年級'],
                                userData: null
                            }
                        };
                    case 'health':
                        return {
                            success: true,
                            data: {
                                status: 'healthy',
                                timestamp: new Date().toISOString()
                            }
                        };
                    default:
                        return { success: true, data: {} };
                }
            },
            
            async getCourses() {
                const result = await this.request('getCourses');
                if (result.success) {
                    return result.data;
                }
                throw new Error(result.error || 'API 請求失敗');
            },
            
            async getUser() {
                const result = await this.request('getUser');
                if (result.success) {
                    return result.data;
                }
                throw new Error(result.error || 'API 請求失敗');
            },
            
            async checkRegistration() {
                const result = await this.request('checkRegistration');
                if (result.success) {
                    return result.data;
                }
                throw new Error(result.error || 'API 請求失敗');
            },
            
            async testConnection() {
                try {
                    const result = await this.request('health');
                    return result.success;
                } catch {
                    return false;
                }
            }
        };
        
        // 渲染課程卡片
        function renderCourseCard(course) {
            const isEarlyBird = course.是否早鳥;
            const isFull = course.是否額滿;
            const remaining = course.剩餘名額;
            
            return `
                <div class="course-card pb-4 mb-4">
                    <!-- 封面圖片 -->
                    ${course.封面圖網址 ? `
                    <div class="aspect-video bg-gray-100 overflow-hidden mb-3">
                        <img src="${course.封面圖網址}" 
                             alt="${course.課程名稱}"
                             class="w-full h-full object-cover"
                             loading="lazy">
                    </div>
                    ` : ''}
                    
                    <div class="mb-3">
                        <!-- 標題和狀態 -->
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-base font-black text-black flex-1 pr-2">${course.課程名稱}</h3>
                            <span class="text-xs font-black ${isFull ? 'text-red-600' : 'text-green-600'}">
                                ${isFull ? '額滿' : `${remaining} 名額`}
                            </span>
                        </div>
                        
                        <!-- 等級和教練 -->
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-xs font-black text-black bg-yellow-100 px-2 py-1">
                                ${course.要求等級}
                            </span>
                            <span class="text-xs font-black text-black">
                                ${course.教練名稱}
                            </span>
                        </div>
                    </div>
                    
                    <!-- 時間地點 -->
                    <div class="space-y-2 mb-3">
                        <div class="flex items-center text-sm">
                            <i data-lucide="calendar" class="w-4 h-4 text-black mr-2"></i>
                            <span class="font-black text-black">${course.活動日期} ${course.活動時段}</span>
                        </div>
                        <div class="flex items-center text-sm">
                            <i data-lucide="map-pin" class="w-4 h-4 text-black mr-2"></i>
                            <span class="font-black text-black">${course.活動地點}</span>
                        </div>
                    </div>
                    
                    <!-- 價格和按鈕 -->
                    <div class="flex justify-between items-center pt-3 border-t border-gray-100">
                        <div>
                            ${isEarlyBird && course.早鳥價 > 0 ? `
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-gray-500 line-through">${course.原價} PT</span>
                                <span class="text-lg font-black text-red-600">${course.早鳥價} PT</span>
                            </div>
                            ` : `
                            <span class="text-lg font-black text-black">${course.原價} PT</span>
                            `}
                        </div>
                        
                        <button class="btn-detail px-4 py-2 bg-black text-white text-sm font-black"
                                data-course-id="${course.UUID}">
                            詳細說明
                        </button>
                    </div>
                </div>
            `;
        }
        
        // 載入首頁
        async function loadHomeView() {
            const content = document.getElementById('main-content');
            content.innerHTML = `
                <div class="flex flex-col items-center justify-center py-12">
                    <div class="loading mb-4"></div>
                    <p class="text-black font-medium">載入課程中...</p>
                </div>
            `;
            
            try {
                console.log('開始載入課程...');
                const data = await api.getCourses();
                const courses = data?.courses || [];
                
                console.log('載入到課程:', courses.length, '個');
                
                if (courses.length === 0) {
                    content.innerHTML = `
                        <div class="text-center py-12">
                            <div class="text-gray-300 mb-4">
                                <i data-lucide="calendar" class="w-16 h-16 mx-auto"></i>
                            </div>
                            <h3 class="text-lg font-black text-black mb-2">暫無課程</h3>
                            <p class="text-gray-600">目前沒有可預約的課程</p>
                            <button onclick="loadHomeView()" class="mt-4 px-4 py-2 bg-black text-white font-black">
                                重新載入
                            </button>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }
                
                let html = `
                    <div class="mb-6">
                        <h2 class="text-xl font-black text-black mb-2">可預約課程</h2>
                        <p class="text-sm text-gray-600">共 ${courses.length} 個課程</p>
                    </div>
                    
                    <div class="space-y-0">
                `;
                
                courses.forEach((course, index) => {
                    html += renderCourseCard(course);
                });
                
                html += '</div>';
                content.innerHTML = html;
                
                // 初始化圖標
                lucide.createIcons();
                
                // 綁定詳情按鈕事件
                document.querySelectorAll('.btn-detail').forEach(button => {
                    button.addEventListener('click', function() {
                        const courseId = this.dataset.courseId;
                        const course = courses.find(c => c.UUID === courseId);
                        if (course) {
                            showMessage(course.課程名稱, course.文字簡介);
                        }
                    });
                });
                
                console.log('課程載入完成');
                
            } catch (error) {
                console.error('載入課程失敗:', error);
                content.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-red-600 mb-4">
                            <i data-lucide="alert-circle" class="w-16 h-16 mx-auto"></i>
                        </div>
                        <h3 class="text-lg font-black text-black mb-2">載入失敗</h3>
                        <p class="text-gray-600 mb-4">無法載入課程資訊</p>
                        <button onclick="loadHomeView()" class="px-4 py-2 bg-black text-white font-black">
                            重新載入
                        </button>
                    </div>
                `;
                lucide.createIcons();
            }
        }
        
        // 載入會員頁面
        async function loadProfileView() {
            try {
                const data = await api.getUser();
                const user = data?.user || {};
                const userName = localStorage.getItem('user_name') || user.學員姓名 || '使用者';
                
                const html = `
                    <div class="py-6">
                        <div class="mb-6">
                            <h2 class="text-xl font-black text-black mb-2">會員專區</h2>
                            <p class="text-sm text-gray-600">管理您的個人資料和預約</p>
                        </div>
                        
                        <!-- 用戶資訊卡片 -->
                        <div class="bg-gray-50 p-4 mb-6">
                            <div class="flex items-center mb-4">
                                <div class="w-12 h-12 bg-black rounded-full flex items-center justify-center text-white font-black mr-3">
                                    ${userName.charAt(0)}
                                </div>
                                <div>
                                    <h3 class="text-base font-black text-black">${userName}</h3>
                                    <p class="text-sm text-gray-600">LINE: ${userProfile?.displayName || ''}</p>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <div class="text-xs font-black text-gray-600 mb-1">家長姓名</div>
                                    <div class="text-sm font-black text-black">${user.家長姓名 || '未填寫'}</div>
                                </div>
                                <div>
                                    <div class="text-xs font-black text-gray-600 mb-1">聯繫電話</div>
                                    <div class="text-sm font-black text-black">${user.聯繫電話 || '未填寫'}</div>
                                </div>
                                <div>
                                    <div class="text-xs font-black text-gray-600 mb-1">學員姓名</div>
                                    <div class="text-sm font-black text-black">${user.學員姓名 || '未填寫'}</div>
                                </div>
                                <div>
                                    <div class="text-xs font-black text-gray-600 mb-1">性別</div>
                                    <div class="text-sm font-black text-black">${user.性別 || '未填寫'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 功能區塊 -->
                        <div class="space-y-4">
                            <div class="border-b border-gray-100 pb-4">
                                <h4 class="text-base font-black text-black mb-2">點數餘額</h4>
                                <div class="flex items-center justify-between">
                                    <span class="text-2xl font-black text-black">${user.點數餘額 || 0} PT</span>
                                    <button class="px-4 py-2 bg-black text-white text-sm font-black">
                                        購買點數
                                    </button>
                                </div>
                            </div>
                            
                            <div>
                                <button onclick="showEditProfile()" class="w-full py-3 border border-gray-300 text-black font-black mb-3">
                                    編輯資料
                                </button>
                                <button onclick="logout()" class="w-full py-3 border border-gray-300 text-black font-black">
                                    登出
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('main-content').innerHTML = html;
                lucide.createIcons();
                
            } catch (error) {
                console.error('載入會員資料失敗:', error);
                document.getElementById('main-content').innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-red-600 mb-4">
                            <i data-lucide="alert-circle" class="w-16 h-16 mx-auto"></i>
                        </div>
                        <h3 class="text-lg font-black text-black mb-2">載入失敗</h3>
                        <p class="text-gray-600">無法載入會員資料</p>
                    </div>
                `;
                lucide.createIcons();
            }
        }
        
        // 載入紀錄頁面
        function loadHistoryView() {
            document.getElementById('main-content').innerHTML = `
                <div class="py-6">
                    <div class="mb-6">
                        <h2 class="text-xl font-black text-black mb-2">預約紀錄</h2>
                        <p class="text-sm text-gray-600">查看您的課程預約歷史</p>
                    </div>
                    
                    <div class="text-center py-12">
                        <div class="text-gray-300 mb-4">
                            <i data-lucide="history" class="w-16 h-16 mx-auto"></i>
                        </div>
                        <h3 class="text-lg font-black text-black mb-2">暫無預約紀錄</h3>
                        <p class="text-gray-600">您還沒有預約過任何課程</p>
                        <button onclick="loadView('home')" class="mt-4 px-4 py-2 bg-black text-white font-black">
                            瀏覽課程
                        </button>
                    </div>
                </div>
            `;
            
            lucide.createIcons();
        }
        
        // 編輯資料表單
        function showEditProfile() {
            const html = `
                <div class="py-6">
                    <div class="mb-6">
                        <h2 class="text-xl font-black text-black mb-2">編輯會員資料</h2>
                        <p class="text-sm text-gray-600">請填寫以下必要資料以進行課程預約</p>
                    </div>
                    
                    <form id="edit-form" class="space-y-4">
                        <div>
                            <label class="block text-xs font-black text-black mb-2">家長姓名 *</label>
                            <input type="text" name="家長姓名" required 
                                   class="w-full px-3 py-2 border-b-2 border-black bg-gray-50">
                        </div>
                        <div>
                            <label class="block text-xs font-black text-black mb-2">聯繫電話 *</label>
                            <input type="tel" name="聯繫電話" required pattern="09[0-9]{8}"
                                   class="w-full px-3 py-2 border-b-2 border-black bg-gray-50" 
                                   placeholder="0912345678">
                            <p class="text-xs text-gray-600 mt-1">請輸入台灣手機號碼</p>
                        </div>
                        <div>
                            <label class="block text-xs font-black text-black mb-2">學員姓名 *</label>
                            <input type="text" name="學員姓名" required
                                   class="w-full px-3 py-2 border-b-2 border-black bg-gray-50">
                        </div>
                        <div>
                            <label class="block text-xs font-black text-black mb-2">性別 *</label>
                            <select name="性別" required class="w-full px-3 py-2 border-b-2 border-black bg-gray-50">
                                <option value="">請選擇</option>
                                <option value="男">男</option>
                                <option value="女">女</option>
                            </select>
                        </div>
                        
                        <div class="pt-4">
                            <button type="button" onclick="saveProfile()" class="w-full py-3 bg-black text-white font-black">
                                儲存資料
                            </button>
                            <button type="button" onclick="loadView('profile')" 
                                    class="w-full py-3 border border-gray-300 text-black font-black mt-3">
                                取消
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = html;
            lucide.createIcons();
        }
        
        // 儲存資料
        function saveProfile() {
            showMessage('成功', '資料已儲存！');
            setTimeout(() => {
                loadView('profile');
            }, 1500);
        }
        
        // 登出
        function logout() {
            localStorage.clear();
            if (liff.isLoggedIn()) {
                liff.logout();
            }
            location.reload();
        }
        
        // 載入視圖
        function loadView(view) {
            // 更新導航狀態
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.view === view) {
                    item.classList.add('active');
                }
            });
            
            // 更新 URL
            window.history.pushState({}, '', '#' + view);
            
            switch (view) {
                case 'home':
                    loadHomeView();
                    break;
                case 'profile':
                    loadProfileView();
                    break;
                case 'history':
                    loadHistoryView();
                    break;
                default:
                    document.getElementById('main-content').innerHTML = `
                        <div class="p-8 text-center">
                            <p class="text-black">找不到頁面</p>
                        </div>
                    `;
            }
        }
        
        // 檢查註冊狀態
        async function checkRegistration() {
            try {
                const data = await api.checkRegistration();
                if (!data.isRegistered) {
                    setTimeout(() => {
                        showMessage('請完善資料', '請先填寫基本資料以進行課程預約');
                    }, 2000);
                }
            } catch (error) {
                console.log('檢查註冊狀態失敗:', error);
            }
        }
        
        // 主初始化函數
        async function initializeApp() {
            try {
                console.log('開始初始化應用...');
                
                const liffSuccess = await initializeLIFF();
                if (!liffSuccess && navigator.userAgent.includes('Line')) {
                    document.getElementById('loading').innerHTML = `
                        <div class="text-center">
                            <div class="text-red-600 mb-4">
                                <i data-lucide="alert-circle" class="w-16 h-16"></i>
                            </div>
                            <h3 class="text-lg font-black text-black mb-2">初始化失敗</h3>
                            <p class="text-gray-600 mb-4">請重新整理頁面</p>
                            <button onclick="location.reload()" class="px-4 py-2 bg-black text-white font-black">
                                重新整理
                            </button>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }
                
                // 測試 API 連接
                console.log('測試 API 連接...');
                const apiConnected = await api.testConnection();
                if (!apiConnected) {
                    console.log('API 連接失敗，使用模擬數據');
                    useMockData = true;
                } else {
                    console.log('API 連接成功');
                    useMockData = false;
                }
                
                // 隱藏載入畫面
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                
                // 載入首頁
                loadView('home');
                
                // 檢查註冊狀態
                await checkRegistration();
                
                console.log('應用初始化完成');
                
            } catch (error) {
                console.error('應用初始化失敗:', error);
                
                document.getElementById('loading').innerHTML = `
                    <div class="text-center">
                        <div class="text-red-600 mb-4">
                            <i data-lucide="alert-circle" class="w-16 h-16"></i>
                        </div>
                        <h3 class="text-lg font-black text-black mb-2">發生錯誤</h3>
                        <p class="text-gray-600 mb-4">${error.message}</p>
                        <button onclick="location.reload()" class="px-4 py-2 bg-black text-white font-black">
                            重新整理
                        </button>
                    </div>
                `;
                lucide.createIcons();
            }
        }
        
        // 綁定導航事件
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const view = this.dataset.view;
                    loadView(view);
                });
            });
            
            // 處理瀏覽器後退/前進按鈕
            window.addEventListener('popstate', function() {
                const view = window.location.hash.replace('#', '') || 'home';
                loadView(view);
            });
            
            // 初始化應用
            if (typeof liff !== 'undefined') {
                initializeApp();
            } else {
                setTimeout(() => {
                    if (typeof liff === 'undefined') {
                        console.log('LIFF SDK 載入失敗，使用測試模式');
                        document.getElementById('loading').classList.add('hidden');
                        document.getElementById('main-content').classList.remove('hidden');
                        loadView('home');
                    }
                }, 2000);
            }
        });
        
        // 導出函數
        window.loadView = loadView;
        window.showEditProfile = showEditProfile;
        window.saveProfile = saveProfile;
        window.logout = logout;
    </script>
</body>
</html>
