<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sports Island | 運動課程預約</title>
    
    <!-- LINE LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* 基礎樣式 */
        * {
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            color: #000000;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        
        /* 高對比度文字 */
        .text-high-contrast {
            color: #000000 !important;
        }
        
        /* 底部導航 */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: #ffffff;
            border-top: 1px solid #e5e7eb;
            display: flex;
            z-index: 100;
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #000000;
            opacity: 0.5;
            text-decoration: none;
            transition: opacity 0.2s;
        }
        
        .nav-item.active {
            opacity: 1;
        }
        
        .nav-item i {
            width: 20px;
            height: 20px;
            margin-bottom: 4px;
        }
        
        .nav-item span {
            font-size: 11px;
            font-weight: 900;
        }
        
        /* 載入動畫 */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #000000;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen pb-16">
        <!-- 導航欄 -->
        <header class="sticky top-0 bg-white border-b border-gray-100 z-10">
            <div class="px-4 py-3">
                <h1 class="text-lg font-black text-black">SPORTS ISLAND</h1>
            </div>
        </header>
        
        <!-- 主要內容 -->
        <main id="content" class="p-4">
            <div id="loading" class="flex flex-col items-center justify-center min-h-[60vh]">
                <div class="loading mb-4"></div>
                <p class="text-black font-medium">正在初始化系統...</p>
            </div>
            
            <div id="main-content" class="hidden">
                <!-- 內容會動態載入到這裡 -->
            </div>
        </main>
        
        <!-- 底部導航 -->
        <div class="bottom-nav">
            <a href="#home" class="nav-item" data-view="home">
                <i data-lucide="home"></i>
                <span>課程</span>
            </a>
            <a href="#history" class="nav-item" data-view="history">
                <i data-lucide="history"></i>
                <span>紀錄</span>
            </a>
            <a href="#profile" class="nav-item" data-view="profile">
                <i data-lucide="user"></i>
                <span>會員</span>
            </a>
        </div>
        
        <!-- 彈出視窗 -->
        <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-md">
                <div class="p-6">
                    <h3 id="modal-title" class="text-lg font-black text-black mb-2"></h3>
                    <p id="modal-message" class="text-black mb-6"></p>
                    <button id="modal-ok" class="w-full py-3 bg-black text-white font-black">確定</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 配置 - 請更新這些值！
        const CONFIG = {
            LIFF_ID: '2008786875-F7ifLsbN', // 您的 LIFF ID
            API_BASE_URL: 'https://aged-rice-2438.wetw-net3.workers.dev/' // Cloudflare Worker URL
        };
        
        // 全局變數
        let userId = null;
        let userProfile = null;
        
        // 顯示訊息
        function showMessage(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal').classList.remove('hidden');
        }
        
        // 關閉訊息
        document.getElementById('modal-ok').addEventListener('click', function() {
            document.getElementById('modal').classList.add('hidden');
        });
        
        // 初始化 LIFF
        async function initializeLIFF() {
            try {
                console.log('正在初始化 LIFF...');
                
                // 初始化 LIFF
                await liff.init({
                    liffId: CONFIG.LIFF_ID,
                    withLoginOnExternalBrowser: true
                });
                
                console.log('LIFF 初始化成功');
                
                // 檢查是否已登入
                if (!liff.isLoggedIn()) {
                    console.log('用戶未登入，執行登入...');
                    // 在 LINE 內自動登入
                    liff.login({
                        redirectUri: window.location.href
                    });
                    return false;
                }
                
                // 獲取用戶資料
                userProfile = await liff.getProfile();
                userId = userProfile.userId;
                
                console.log('用戶資料:', userProfile);
                console.log('用戶ID:', userId);
                
                // 儲存用戶 ID
                localStorage.setItem('sportflow_user_id', userId);
                
                return true;
                
            } catch (error) {
                console.error('LIFF 初始化失敗:', error);
                
                // 檢查是否在 LINE 環境中
                if (navigator.userAgent.includes('Line')) {
                    showMessage('初始化失敗', '請重新整理頁面或稍後再試');
                } else {
                    showMessage('請在 LINE 中開啟', '此應用需要在 LINE 官方帳號中開啟，請在 LINE 中點擊連結或掃描 QR Code。');
                }
                
                return false;
            }
        }
        
        // API 服務
        const api = {
            async request(endpoint, data = {}) {
                try {
                    const response = await fetch(CONFIG.API_BASE_URL + endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'User-Id': userId || ''
                        },
                        body: JSON.stringify(data)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (!result.success) {
                        throw new Error(result.error || 'API 請求失敗');
                    }
                    
                    return result.data;
                    
                } catch (error) {
                    console.error('API 請求失敗:', error);
                    throw error;
                }
            },
            
            async getCourses() {
                return this.request('/api/courses', { action: 'getCourses' });
            },
            
            async getUser() {
                return this.request('/api/user', { action: 'getUser' });
            },
            
            async checkRegistration() {
                return this.request('/api/user', { action: 'checkRegistration' });
            },
            
            async healthCheck() {
                try {
                    const response = await fetch(CONFIG.API_BASE_URL + '/api/health');
                    return response.ok;
                } catch {
                    return false;
                }
            }
        };
        
        // 渲染首頁
        async function renderHomeView() {
            try {
                const data = await api.getCourses();
                const courses = data?.courses || [];
                
                let html = `
                    <div class="mb-6">
                        <h2 class="text-xl font-black text-black mb-2">可預約課程</h2>
                        <p class="text-sm text-gray-600">選擇您感興趣的課程</p>
                    </div>
                `;
                
                if (courses.length === 0) {
                    html += `
                        <div class="text-center py-12">
                            <div class="text-gray-300 mb-4">
                                <i data-lucide="calendar" class="w-16 h-16 mx-auto"></i>
                            </div>
                            <p class="text-gray-600">目前沒有可預約的課程</p>
                        </div>
                    `;
                } else {
                    html += '<div class="space-y-4">';
                    
                    courses.forEach(course => {
                        html += `
                            <div class="border-b border-gray-100 pb-4 last:border-b-0">
                                <h3 class="text-base font-black text-black mb-2">${course.課程名稱}</h3>
                                <div class="space-y-1 mb-3">
                                    <div class="flex items-center text-sm">
                                        <i data-lucide="calendar" class="w-4 h-4 text-black mr-2"></i>
                                        <span>${course.活動日期} ${course.活動時段}</span>
                                    </div>
                                    <div class="flex items-center text-sm">
                                        <i data-lucide="map-pin" class="w-4 h-4 text-black mr-2"></i>
                                        <span>${course.活動地點}</span>
                                    </div>
                                    <div class="flex items-center text-sm">
                                        <i data-lucide="user" class="w-4 h-4 text-black mr-2"></i>
                                        <span>${course.教練名稱} • ${course.要求等級}</span>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-lg font-black text-black">${course.原價} PT</span>
                                    <button class="px-4 py-2 bg-black text-white text-sm font-black">詳細說明</button>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }
                
                return html;
                
            } catch (error) {
                console.error('載入課程失敗:', error);
                return `
                    <div class="text-center py-12">
                        <div class="text-red-600 mb-4">
                            <i data-lucide="alert-circle" class="w-16 h-16 mx-auto"></i>
                        </div>
                        <p class="text-gray-600 mb-4">載入課程失敗</p>
                        <button onclick="loadHomeView()" class="px-4 py-2 bg-black text-white font-black">
                            重新載入
                        </button>
                    </div>
                `;
            }
        }
        
        // 載入首頁
        async function loadHomeView() {
            const content = document.getElementById('main-content');
            content.innerHTML = `
                <div class="flex items-center justify-center py-12">
                    <div class="loading"></div>
                </div>
            `;
            
            const html = await renderHomeView();
            content.innerHTML = html;
            
            // 初始化圖標
            lucide.createIcons();
        }
        
        // 檢查註冊狀態
        async function checkRegistration() {
            try {
                const data = await api.checkRegistration();
                
                if (!data?.isRegistered) {
                    // 顯示註冊提示
                    setTimeout(() => {
                        showMessage('請完善資料', '請先填寫基本資料以進行課程預約');
                    }, 1000);
                }
            } catch (error) {
                console.error('檢查註冊狀態失敗:', error);
            }
        }
        
        // 主初始化函數
        async function initializeApp() {
            try {
                console.log('開始初始化應用...');
                
                // 初始化 LIFF
                const liffSuccess = await initializeLIFF();
                
                if (!liffSuccess) {
                    return;
                }
                
                // 檢查 API 連線
                const apiHealthy = await api.healthCheck();
                
                if (!apiHealthy) {
                    showMessage('連線失敗', '無法連線到伺服器，請稍後再試');
                    return;
                }
                
                console.log('API 連線正常');
                
                // 隱藏載入畫面
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                
                // 載入首頁
                await loadHomeView();
                
                // 檢查註冊狀態
                await checkRegistration();
                
                console.log('應用初始化完成');
                
            } catch (error) {
                console.error('應用初始化失敗:', error);
                showMessage('初始化失敗', '請重新整理頁面或稍後再試');
            }
        }
        
        // 底部導航事件
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                
                // 移除所有 active 類
                document.querySelectorAll('.nav-item').forEach(nav => {
                    nav.classList.remove('active');
                });
                
                // 添加 active 類到當前項目
                this.classList.add('active');
                
                // 根據點擊的視圖加載內容
                const view = this.getAttribute('data-view');
                
                if (view === 'home') {
                    loadHomeView();
                } else if (view === 'profile') {
                    document.getElementById('main-content').innerHTML = `
                        <div class="py-8 text-center">
                            <p class="text-gray-600">會員專區功能開發中</p>
                        </div>
                    `;
                } else if (view === 'history') {
                    document.getElementById('main-content').innerHTML = `
                        <div class="py-8 text-center">
                            <p class="text-gray-600">預約紀錄功能開發中</p>
                        </div>
                    `;
                }
            });
        });
        
        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 等待 LIFF SDK 載入
            if (typeof liff !== 'undefined') {
                initializeApp();
            } else {
                // LIFF SDK 載入失敗
                setTimeout(() => {
                    if (typeof liff === 'undefined') {
                        showMessage('SDK 載入失敗', '請檢查網路連線並重新整理頁面');
                    }
                }, 3000);
            }
        });
        
        // 全局錯誤處理
        window.addEventListener('error', function(event) {
            console.error('全局錯誤:', event.error);
        });
    </script>
</body>
</html>
