<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sports Island | 運動課程預約</title>
    
    <!-- LINE LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            color: #000000;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #000000;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: #ffffff;
            border-top: 1px solid #e5e7eb;
            display: flex;
            z-index: 100;
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #000000;
            opacity: 0.5;
            text-decoration: none;
            transition: opacity 0.2s;
        }
        
        .nav-item.active {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen pb-16">
        <!-- 導航欄 -->
        <header class="sticky top-0 bg-white border-b border-gray-100 z-10">
            <div class="px-4 py-3">
                <h1 class="text-lg font-black text-black">SPORTS ISLAND</h1>
            </div>
        </header>
        
        <!-- 主要內容 -->
        <main id="content" class="p-4">
            <div id="loading" class="flex flex-col items-center justify-center min-h-[60vh]">
                <div class="loading mb-4"></div>
                <p class="text-black font-medium">正在初始化...</p>
            </div>
            
            <div id="main-content" class="hidden">
                <!-- 內容會動態載入到這裡 -->
            </div>
        </main>
        
        <!-- 底部導航 -->
        <div class="bottom-nav">
            <a href="#home" class="nav-item active" data-view="home">
                <i data-lucide="home"></i>
                <span>課程</span>
            </a>
            <a href="#history" class="nav-item" data-view="history">
                <i data-lucide="history"></i>
                <span>紀錄</span>
            </a>
            <a href="#profile" class="nav-item" data-view="profile">
                <i data-lucide="user"></i>
                <span>會員</span>
            </a>
        </div>
    </div>
    
    <script>
        // 配置
        const CONFIG = {
            LIFF_ID: '2008786875-F7ifLsbN',
            USE_MOCK_DATA: true // 使用模擬數據，先跳過 API
        };
        
        // 模擬數據
        const MOCK_DATA = {
            courses: [
                {
                    UUID: 'test-001',
                    課程名稱: '兒童籃球基礎班',
                    要求等級: '初級',
                    教練名稱: '張教練',
                    活動日期: '2024-01-20',
                    活動時段: '14:30',
                    原價: 800,
                    早鳥價: 600,
                    招生名額: 20,
                    候補名額: 5,
                    課程狀態: 'Open',
                    封面圖網址: '',
                    說明圖網址: '',
                    文字簡介: '適合6-12歲初學者的籃球課程，學習基本運球、傳球和投籃技巧。',
                    活動地點: '陽光運動中心 3F 籃球場',
                    是否早鳥: true,
                    是否額滿: false,
                    剩餘名額: 15
                },
                {
                    UUID: 'test-002',
                    課程名稱: '青少年羽球進階班',
                    要求等級: '進階',
                    教練名稱: '李教練',
                    活動日期: '2024-01-22',
                    活動時段: '16:00',
                    原價: 1200,
                    早鳥價: 900,
                    招生名額: 15,
                    候補名額: 3,
                    課程狀態: 'Open',
                    封面圖網址: '',
                    說明圖網址: '',
                    文字簡介: '適合有一定基礎的青少年學員，提升羽球技術和戰術意識。',
                    活動地點: '星光羽球館 主場地',
                    是否早鳥: true,
                    是否額滿: false,
                    剩餘名額: 8
                },
                {
                    UUID: 'test-003',
                    課程名稱: '成人游泳高級班',
                    要求等級: '高級',
                    教練名稱: '王教練',
                    活動日期: '2024-01-25',
                    活動時段: '19:00',
                    原價: 1500,
                    早鳥價: 1200,
                    招生名額: 10,
                    候補名額: 2,
                    課程狀態: 'Open',
                    封面圖網址: '',
                    說明圖網址: '',
                    文字簡介: '針對已有游泳基礎的成人學員，學習蝶泳、轉身技巧和長距離游泳。',
                    活動地點: '藍海游泳池 50M水道',
                    是否早鳥: false,
                    是否額滿: false,
                    剩餘名額: 5
                }
            ]
        };
        
        // 模擬 API
        const mockApi = {
            async getCourses() {
                return new Promise(resolve => {
                    setTimeout(() => {
                        resolve({ courses: MOCK_DATA.courses });
                    }, 500);
                });
            },
            
            async healthCheck() {
                return true;
            }
        };
        
        // 初始化 LIFF
        async function initializeLIFF() {
            try {
                console.log('正在初始化 LIFF...');
                
                await liff.init({
                    liffId: CONFIG.LIFF_ID,
                    withLoginOnExternalBrowser: true
                });
                
                console.log('LIFF 初始化成功');
                
                if (!liff.isLoggedIn()) {
                    console.log('用戶未登入，執行登入...');
                    liff.login();
                    return false;
                }
                
                const profile = await liff.getProfile();
                console.log('用戶資料:', profile);
                
                // 儲存用戶資料
                localStorage.setItem('user_id', profile.userId);
                localStorage.setItem('user_name', profile.displayName);
                
                return true;
                
            } catch (error) {
                console.error('LIFF 初始化失敗:', error);
                
                // 如果不是在 LINE 環境，仍然顯示內容（開發測試用）
                if (!navigator.userAgent.includes('Line')) {
                    console.log('非 LINE 環境，使用測試模式');
                    return true;
                }
                
                return false;
            }
        }
        
        // 渲染課程卡片
        function renderCourseCard(course) {
            const isEarlyBird = course.是否早鳥;
            const isFull = course.是否額滿;
            
            return `
                <div class="course-card border-b border-gray-100 last:border-b-0 pb-4 mb-4">
                    <div class="mb-3">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-base font-black text-black flex-1 pr-2">${course.課程名稱}</h3>
                            <span class="text-xs font-black ${isFull ? 'text-red-600' : 'text-green-600'}">
                                ${isFull ? '額滿' : `${course.剩餘名額} 名額`}
                            </span>
                        </div>
                        
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-xs font-black text-black bg-yellow-100 px-2 py-1">
                                ${course.要求等級}
                            </span>
                            <span class="text-xs font-black text-black">
                                ${course.教練名稱}
                            </span>
                        </div>
                    </div>
                    
                    <div class="space-y-2 mb-3">
                        <div class="flex items-center text-sm">
                            <i data-lucide="calendar" class="w-4 h-4 text-black mr-2"></i>
                            <span class="font-black text-black">${course.活動日期} ${course.活動時段}</span>
                        </div>
                        <div class="flex items-center text-sm">
                            <i data-lucide="map-pin" class="w-4 h-4 text-black mr-2"></i>
                            <span class="font-black text-black">${course.活動地點}</span>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center pt-3 border-t border-gray-100">
                        <div>
                            ${isEarlyBird && course.早鳥價 > 0 ? `
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-gray-500 line-through">${course.原價} PT</span>
                                <span class="text-lg font-black text-red-600">${course.早鳥價} PT</span>
                            </div>
                            ` : `
                            <span class="text-lg font-black text-black">${course.原價} PT</span>
                            `}
                        </div>
                        
                        <button class="btn-detail px-4 py-2 bg-black text-white text-sm font-black"
                                data-course-id="${course.UUID}">
                            詳細說明
                        </button>
                    </div>
                </div>
            `;
        }
        
        // 渲染首頁
        async function renderHomeView() {
            try {
                const api = CONFIG.USE_MOCK_DATA ? mockApi : window.api;
                const data = await api.getCourses();
                const courses = data?.courses || [];
                
                if (courses.length === 0) {
                    return `
                        <div class="text-center py-12">
                            <div class="text-gray-300 mb-4">
                                <i data-lucide="calendar" class="w-16 h-16 mx-auto"></i>
                            </div>
                            <h3 class="text-lg font-black text-black mb-2">暫無課程</h3>
                            <p class="text-gray-600">目前沒有可預約的課程</p>
                        </div>
                    `;
                }
                
                let html = `
                    <div class="mb-6">
                        <h2 class="text-xl font-black text-black mb-2">可預約課程</h2>
                        <p class="text-sm text-gray-600">選擇您感興趣的課程</p>
                    </div>
                    
                    <div class="space-y-4">
                `;
                
                courses.forEach(course => {
                    html += renderCourseCard(course);
                });
                
                html += '</div>';
                
                return html;
                
            } catch (error) {
                console.error('載入課程失敗:', error);
                return `
                    <div class="text-center py-12">
                        <div class="text-red-600 mb-4">
                            <i data-lucide="alert-circle" class="w-16 h-16 mx-auto"></i>
                        </div>
                        <h3 class="text-lg font-black text-black mb-2">載入失敗</h3>
                        <p class="text-gray-600 mb-4">無法載入課程資訊</p>
                        <button onclick="loadHomeView()" class="px-4 py-2 bg-black text-white font-black">
                            重新載入
                        </button>
                    </div>
                `;
            }
        }
        
        // 渲染課程詳情
        function renderCourseDetail(course) {
            const isEarlyBird = course.是否早鳥;
            const isFull = course.是否額滿;
            
            return `
                <div class="course-detail">
                    <div class="mb-6">
                        <h2 class="text-xl font-black text-black mb-3">${course.課程名稱}</h2>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <div class="text-xs font-black text-gray-600 mb-1">教練</div>
                                <div class="text-base font-black text-black">${course.教練名稱}</div>
                            </div>
                            <div>
                                <div class="text-xs font-black text-gray-600 mb-1">等級</div>
                                <div class="text-base font-black text-black">${course.要求等級}</div>
                            </div>
                            <div class="col-span-2">
                                <div class="text-xs font-black text-gray-600 mb-1">時間</div>
                                <div class="text-base font-black text-black">${course.活動日期} ${course.活動時段}</div>
                            </div>
                            <div class="col-span-2">
                                <div class="text-xs font-black text-gray-600 mb-1">地點</div>
                                <div class="text-base font-black text-black">${course.活動地點}</div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 p-4 mb-4">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="text-xs font-black text-gray-600 mb-1">費用</div>
                                    ${isEarlyBird && course.早鳥價 > 0 ? `
                                    <div class="flex items-center gap-2">
                                        <span class="text-sm text-gray-500 line-through">${course.原價} PT</span>
                                        <span class="text-xl font-black text-red-600">${course.早鳥價} PT</span>
                                    </div>
                                    ` : `
                                    <div class="text-xl font-black text-black">${course.原價} PT</div>
                                    `}
                                </div>
                                <div>
                                    <div class="text-xs font-black text-gray-600 mb-1">名額</div>
                                    <div class="text-base font-black text-black">
                                        ${course.招生名額} / ${course.候補名額}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <div class="text-xs font-black text-gray-600 mb-2">課程說明</div>
                            <div class="text-black leading-relaxed">
                                ${course.文字簡介}
                            </div>
                        </div>
                        
                        <button class="w-full py-3 bg-black text-white text-lg font-black">
                            ${isFull ? '已額滿' : '立即預約'}
                        </button>
                    </div>
                </div>
            `;
        }
        
        // 載入首頁
        async function loadHomeView() {
            const content = document.getElementById('main-content');
            content.innerHTML = `
                <div class="flex items-center justify-center py-12">
                    <div class="loading"></div>
                </div>
            `;
            
            const html = await renderHomeView();
            content.innerHTML = html;
            
            // 初始化圖標
            lucide.createIcons();
            
            // 綁定課程詳情按鈕事件
            document.querySelectorAll('.btn-detail').forEach(button => {
                button.addEventListener('click', function() {
                    const courseId = this.dataset.courseId;
                    const course = MOCK_DATA.courses.find(c => c.UUID === courseId);
                    
                    if (course) {
                        alert(`課程詳情: ${course.課程名稱}\n\n${course.文字簡介}`);
                    }
                });
            });
        }
        
        // 載入會員頁面
        function loadProfileView() {
            const userName = localStorage.getItem('user_name') || '使用者';
            
            return `
                <div class="py-6">
                    <div class="mb-6">
                        <h2 class="text-xl font-black text-black mb-2">會員專區</h2>
                        <p class="text-sm text-gray-600">管理您的個人資料和預約</p>
                    </div>
                    
                    <div class="bg-gray-50 p-4 mb-6">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 bg-black rounded-full flex items-center justify-center text-white font-black mr-3">
                                ${userName.charAt(0)}
                            </div>
                            <div>
                                <h3 class="text-base font-black text-black">${userName}</h3>
                                <p class="text-sm text-gray-600">歡迎回來！</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="border-b border-gray-100 pb-4">
                            <h4 class="text-base font-black text-black mb-2">基本資料</h4>
                            <p class="text-sm text-gray-600 mb-3">請完善您的個人資料以進行課程預約</p>
                            <button class="w-full py-3 border border-gray-300 text-black font-black">
                                填寫基本資料
                            </button>
                        </div>
                        
                        <div class="border-b border-gray-100 pb-4">
                            <h4 class="text-base font-black text-black mb-2">點數餘額</h4>
                            <div class="flex items-center justify-between">
                                <span class="text-2xl font-black text-black">0 PT</span>
                                <button class="px-4 py-2 bg-black text-white text-sm font-black">
                                    購買點數
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <button onclick="localStorage.clear(); location.reload();" 
                                    class="w-full py-3 border border-gray-300 text-black font-black">
                                登出
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // 載入紀錄頁面
        function loadHistoryView() {
            return `
                <div class="py-6">
                    <div class="mb-6">
                        <h2 class="text-xl font-black text-black mb-2">預約紀錄</h2>
                        <p class="text-sm text-gray-600">查看您的課程預約歷史</p>
                    </div>
                    
                    <div class="text-center py-12">
                        <div class="text-gray-300 mb-4">
                            <i data-lucide="history" class="w-16 h-16 mx-auto"></i>
                        </div>
                        <h3 class="text-lg font-black text-black mb-2">暫無預約紀錄</h3>
                        <p class="text-gray-600">您還沒有預約過任何課程</p>
                        <button onclick="loadView('home')" class="mt-4 px-4 py-2 bg-black text-white font-black">
                            瀏覽課程
                        </button>
                    </div>
                </div>
            `;
        }
        
        // 載入視圖
        function loadView(view) {
            const content = document.getElementById('main-content');
            
            // 更新導航狀態
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.view === view) {
                    item.classList.add('active');
                }
            });
            
            let html = '';
            
            switch (view) {
                case 'home':
                    loadHomeView();
                    return;
                case 'profile':
                    html = loadProfileView();
                    break;
                case 'history':
                    html = loadHistoryView();
                    break;
                default:
                    html = '<div class="p-8 text-center"><p class="text-black">找不到頁面</p></div>';
            }
            
            content.innerHTML = html;
            lucide.createIcons();
        }
        
        // 主初始化函數
        async function initializeApp() {
            try {
                console.log('開始初始化應用...');
                
                // 初始化 LIFF
                const liffSuccess = await initializeLIFF();
                
                if (!liffSuccess && navigator.userAgent.includes('Line')) {
                    // 在 LINE 環境中但初始化失敗
                    document.getElementById('loading').innerHTML = `
                        <div class="text-center">
                            <div class="text-red-600 mb-4">
                                <i data-lucide="alert-circle" class="w-16 h-16"></i>
                            </div>
                            <h3 class="text-lg font-black text-black mb-2">初始化失敗</h3>
                            <p class="text-gray-600 mb-4">請重新整理頁面或稍後再試</p>
                            <button onclick="location.reload()" class="px-4 py-2 bg-black text-white font-black">
                                重新整理
                            </button>
                        </div>
                    `;
                    return;
                }
                
                // 隱藏載入畫面
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                
                // 載入首頁
                loadView('home');
                
                console.log('應用初始化完成');
                
            } catch (error) {
                console.error('應用初始化失敗:', error);
                
                document.getElementById('loading').innerHTML = `
                    <div class="text-center">
                        <div class="text-red-600 mb-4">
                            <i data-lucide="alert-circle" class="w-16 h-16"></i>
                        </div>
                        <h3 class="text-lg font-black text-black mb-2">發生錯誤</h3>
                        <p class="text-gray-600 mb-4">${error.message}</p>
                        <button onclick="location.reload()" class="px-4 py-2 bg-black text-white font-black">
                            重新整理
                        </button>
                    </div>
                `;
            }
        }
        
        // 綁定導航事件
        document.addEventListener('DOMContentLoaded', function() {
            // 綁定底部導航點擊事件
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const view = this.dataset.view;
                    loadView(view);
                });
            });
            
            // 初始化應用
            if (typeof liff !== 'undefined') {
                initializeApp();
            } else {
                // 如果 LIFF SDK 載入失敗，直接顯示內容（開發測試用）
                setTimeout(() => {
                    if (typeof liff === 'undefined') {
                        console.log('LIFF SDK 載入失敗，使用測試模式');
                        document.getElementById('loading').classList.add('hidden');
                        document.getElementById('main-content').classList.remove('hidden');
                        loadView('home');
                    }
                }, 2000);
            }
        });
        
        // 導出函數供全局使用
        window.loadView = loadView;
        window.loadHomeView = loadHomeView;
    </script>
</body>
</html>
