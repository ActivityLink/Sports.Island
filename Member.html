<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>é‹å‹•å³¶ Sports Island</title>

  <!-- Tailwindï¼ˆé–‹ç™¼ç”¨ï¼‰ -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- LIFF -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont; }
    .nav-btn { color:#94a3b8 }
    .nav-active { color:#16a34a; font-weight:900 }
    .debug-panel {
      position: fixed;
      bottom: 90px;
      right: 12px;
      width: 320px;
      max-height: 50vh;
      background: #020617;
      color: #e5e7eb;
      font-size: 11px;
      border-radius: 12px;
      padding: 12px;
      overflow-y: auto;
      z-index: 9999;
      box-shadow: 0 20px 40px rgba(0,0,0,.4);
    }
    .debug-panel h3 { font-weight:900; margin-bottom:6px; color:#38bdf8 }
    .debug-line { border-bottom:1px dashed #334155; padding:2px 0 }
  </style>
</head>

<body class="bg-slate-100 min-h-screen flex justify-center">

<!-- ===================================================
  ä¸»å®¹å™¨
=================================================== -->
<div class="w-full max-w-md bg-white min-h-screen flex flex-col shadow-xl">

  <!-- Header -->
  <header class="p-5 border-b flex justify-between items-center">
    <h1 class="font-black text-xl">é‹å‹•å³¶ 2026</h1>
    <div class="w-10 h-10 rounded-full bg-slate-200 overflow-hidden">
      <img id="userAvatar" class="w-full h-full object-cover">
    </div>
  </header>

  <!-- ä¸»å…§å®¹ -->
  <main class="flex-1 overflow-y-auto pb-32">

    <!-- èª²ç¨‹ -->
    <section id="view-index">
      <div id="courseContainer" class="p-4 space-y-4 text-sm text-slate-400">
        è¼‰å…¥èª²ç¨‹ä¸­â€¦
      </div>
    </section>

    <!-- ç´€éŒ„ -->
    <section id="view-query" class="hidden">
      <div id="historyContainer" class="p-4 text-sm text-slate-400">
        å°šæœªè®€å–ç´€éŒ„
      </div>
    </section>

    <!-- æœƒå“¡ -->
    <section id="view-member" class="hidden">
      <div class="p-4">
        <button onclick="loadFamily()" class="w-full py-4 bg-black text-white rounded-xl font-bold">
          è®€å–æœƒå“¡è³‡æ–™ï¼ˆDebugï¼‰
        </button>
      </div>
      <div id="familyList" class="p-4 space-y-3 text-sm text-slate-500"></div>
    </section>

  </main>

  <!-- Bottom Nav -->
  <nav class="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-md bg-white border-t flex justify-around py-3">
    <button id="nav-index" class="nav-btn nav-active" onclick="switchView('index')">æ´»å‹•</button>
    <button id="nav-query" class="nav-btn" onclick="switchView('query')">ç´€éŒ„</button>
    <button id="nav-member" class="nav-btn" onclick="switchView('member')">æœƒå“¡</button>
  </nav>
</div>

<!-- ===================================================
  Debug Panelï¼ˆä¸é  F12ï¼‰
=================================================== -->
<div class="debug-panel" id="debugPanel">
  <h3>DEBUG PANEL</h3>
  <div id="debugLog"></div>
</div>

<script>
/* ===================================================
 * ğŸ”’ API è¨­å®šï¼ˆå·²é–æ­» Workerï¼‰
 * =================================================== */
const API_URL = "https://sport.wetw-net3.workers.dev/";

/* ===================================================
 * Debug å·¥å…·
 * =================================================== */
function log(msg) {
  const el = document.getElementById('debugLog');
  const div = document.createElement('div');
  div.className = 'debug-line';
  div.textContent = new Date().toLocaleTimeString() + 'ï½œ' + msg;
  el.prepend(div);
}

/* ===================================================
 * å…¨åŸŸç‹€æ…‹
 * =================================================== */
let currentUid = "";
let familyData = [];

/* ===================================================
 * LIFF åˆå§‹åŒ–
 * =================================================== */
async function init() {
  log("INIT START");
  log("API_URL = " + API_URL);

  try {
    await liff.init({ liffId: "2008792551-CzPJtVB1" });
    log("LIFF init OK");

    if (!liff.isLoggedIn()) {
      log("LIFF not login â†’ redirect");
      liff.login();
      return;
    }

    const profile = await liff.getProfile();
    currentUid = profile.userId;
    document.getElementById('userAvatar').src = profile.pictureUrl;
    log("USER = " + profile.displayName);

    loadCourses();
  } catch (e) {
    log("LIFF ERROR: " + e.message);
  }
}

/* ===================================================
 * èª²ç¨‹
 * =================================================== */
async function loadCourses() {
  log("LOAD COURSES");

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "getCourses" })
    });

    const json = await res.json();
    log("COURSES RESPONSE OK");

    document.getElementById('courseContainer').innerHTML =
      JSON.stringify(json.data || [], null, 2);
  } catch (e) {
    log("COURSES ERROR: " + e.message);
  }
}

/* ===================================================
 * æœƒå“¡ï¼ˆDebug é‡é»ï¼‰
 * =================================================== */
async function loadFamily() {
  log("LOAD FAMILY userId=" + currentUid);

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        action: "getFamily",
        userId: currentUid
      })
    });

    const json = await res.json();
    log("FAMILY RESPONSE = " + JSON.stringify(json));

    const box = document.getElementById('familyList');
    if (!json.data || json.data.length === 0) {
      box.innerHTML = "<div>ï¼ˆç„¡æœƒå“¡è³‡æ–™ï¼‰</div>";
      return;
    }

    box.innerHTML = json.data.map(f => `
      <div class="border rounded p-3">
        <div class="font-bold">${f.name}</div>
        <div class="text-xs">${f.phone}ï½œ${f.relation}</div>
      </div>
    `).join("");
  } catch (e) {
    log("FAMILY ERROR: " + e.message);
  }
}

/* ===================================================
 * åˆ‡æ›é é¢
 * =================================================== */
function switchView(v) {
  ["index","query","member"].forEach(k=>{
    document.getElementById("view-"+k).classList.add("hidden");
    document.getElementById("nav-"+k).classList.remove("nav-active");
  });
  document.getElementById("view-"+v).classList.remove("hidden");
  document.getElementById("nav-"+v).classList.add("nav-active");
  log("SWITCH VIEW â†’ " + v);
}

/* ===================================================
 * å•Ÿå‹•
 * =================================================== */
window.onload = init;
</script>

</body>
</html>
