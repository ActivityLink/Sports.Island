<!-- æª”æ¡ˆåç¨±ï¼šweb/Member.html (V6.7.8 - è§£æ±ºé‡è¤‡å®£å‘Šèˆ‡é€£ç·šç•°å¸¸) -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é‹å‹•å³¶ Sports Island</title>
  <!-- å°å…¥ Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- å°å…¥ LINE SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
    :root { --line-green: #06C755; --bg-gray: #F4F5F7; }
    body { background-color: var(--bg-gray); font-family: 'Noto Sans TC', sans-serif; color: #333; margin: 0; }
    
    .view-section { display: none; }
    .view-section.active { display: block; }
    
    .nav-btn { color: #94a3b8; transition: color 0.2s; border: none; background: none; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .nav-active { color: var(--line-green) !important; font-weight: 900; }
    
    .course-card { background: white; border-radius: 20px; border: 1px solid #E7E9ED; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
    .absent-row { background-color: #fff1f2; color: #e11d48; text-decoration: line-through; opacity: 0.7; }
    
    /* åœ“è§’é€²åº¦å‹•ç•« */
    .spinner { border: 3px solid #f3f3f3; border-top: 3px solid var(--line-green); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="min-h-screen flex justify-center">

  <div class="w-full max-w-md bg-white min-h-screen relative flex flex-col shadow-xl">
    
    <!-- è®€å–é®ç½© (åƒ…å…¨åŸŸè¼‰å…¥æ™‚é¡¯ç¤º) -->
    <div id="loading-mask" class="fixed inset-0 bg-white/95 z-[2000] hidden flex-col items-center justify-center">
      <div class="spinner !w-10 !h-10"></div>
      <p class="mt-4 font-bold text-gray-500 text-sm">æ­£åœ¨åŒæ­¥é‹å‹•å³¶é›²ç«¯è³‡æ–™...</p>
    </div>

    <main class="flex-grow pb-32">
      
      <!-- 1. æ´»å‹•åˆ—è¡¨ (é è¨­é¦–é ) -->
      <section id="view-index" class="view-section active">
        <div class="p-6 border-b flex justify-between items-center bg-white sticky top-0 z-20">
          <div class="flex items-center space-x-2">
            <img src="https://upload.wikimedia.org/wikipedia/commons/4/41/LINE_logo.svg" class="w-6 h-6" alt="LINE">
            <h1 class="text-xl font-black tracking-tight text-slate-800">2026 èª²ç¨‹å ±å</h1>
          </div>
          <img id="userAvatar" class="w-10 h-10 rounded-full border shadow-sm" src="https://via.placeholder.com/40">
        </div>
        <div id="courseContainer" class="p-5 space-y-4">
           <div class="text-center py-20"><div class="spinner"></div><p class="text-slate-300 mt-2 font-bold">è¼‰å…¥èª²ç¨‹ä¸­...</p></div>
        </div>
      </section>

      <!-- 2. å ±åç´€éŒ„ -->
      <section id="view-query" class="view-section">
        <div class="p-6 border-b bg-white sticky top-0 z-20">
          <h2 class="text-xl font-black">æ­·å²å ±åæŸ¥è©¢</h2>
          <p class="text-[10px] text-slate-400 font-bold uppercase mt-1 tracking-widest">Registration Records</p>
        </div>
        <div id="historyContainer" class="p-5 space-y-4">
           <div class="text-center py-20 text-slate-300 font-medium">æ­£åœ¨å–å¾—ç´€éŒ„...</div>
        </div>
      </section>

      <!-- 3. æœƒå“¡ä¸­å¿ƒ (å­¸å“¡åå†Š) -->
      <section id="view-member" class="view-section">
        <div class="p-10 border-b bg-white flex justify-between items-center">
          <div>
            <h1 id="userNameDisplay" class="text-2xl font-black italic text-slate-800">æ‚¨å¥½...</h1>
            <p class="text-xs text-slate-400 font-bold uppercase mt-1">Profile Center</p>
          </div>
        </div>
        <div class="p-6">
          <button onclick="showMemberForm()" class="w-full py-4 bg-black text-white rounded-xl font-bold shadow-lg active:scale-95 transition-transform">+ å»ºç«‹æ–°å­¸å“¡æª”æ¡ˆ</button>
        </div>
        <div id="familyList" class="px-6 space-y-3"></div>
      </section>

      <!-- 4. å­¸å“¡è¡¨å–® -->
      <section id="view-member-form" class="view-section">
        <div class="p-6 border-b flex items-center bg-white">
          <button onclick="switchView('member')" class="text-slate-300 mr-4 font-bold text-xl">â†</button>
          <h2 class="font-bold text-slate-800">æ–°å¢å­¸å“¡è³‡æ–™</h2>
        </div>
        <form id="memberForm" class="p-8 space-y-6">
           <div>
             <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">å­¸å“¡æœ¬å</label>
             <input type="text" id="mName" placeholder="å­¸ç”Ÿå§“å" required class="w-full p-4 bg-slate-50 rounded-xl outline-none border border-transparent focus:border-green-500">
           </div>
           <div class="grid grid-cols-2 gap-4">
             <div>
               <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">æ€§åˆ¥</label>
               <select id="mGender" class="w-full p-4 bg-slate-50 rounded-xl outline-none"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select>
             </div>
             <div>
               <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">ç”Ÿæ—¥</label>
               <input type="date" id="mBirthday" required class="w-full p-4 bg-slate-50 rounded-xl">
             </div>
           </div>
           <div>
             <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">è¯çµ¡é›»è©±</label>
             <input type="tel" id="mPhone" placeholder="å®¶é•·/å­¸ç”Ÿé›»è©±" required class="w-full p-4 bg-slate-50 rounded-xl">
           </div>
           <div>
             <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">èˆ‡æ‚¨çš„é—œä¿‚</label>
             <select id="mRelation" class="w-full p-4 bg-slate-50 rounded-xl outline-none"><option value="æœ¬äºº">æœ¬äºº</option><option value="å­å¥³">å­å¥³</option><option value="å…¶ä»–">å…¶ä»–</option></select>
           </div>
           <button type="submit" class="w-full py-5 bg-green-600 text-white rounded-2xl font-black shadow-xl">å„²å­˜ä¸¦åŒæ­¥é›²ç«¯</button>
        </form>
      </section>
    </main>

    <!-- åº•éƒ¨å°è¦½åˆ— -->
    <nav class="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-md bg-white/95 border-t border-slate-100 px-2 py-3 flex justify-around items-center z-50 shadow-2xl backdrop-blur-md">
      <button onclick="switchView('index')" id="nav-index" class="nav-btn nav-active">
        <span class="text-2xl">ğŸ </span>
        <span class="text-[10px] mt-1 font-bold uppercase">æ´»å‹•</span>
      </button>
      <button onclick="switchView('query')" id="nav-query" class="nav-btn">
        <span class="text-2xl">ğŸ”</span>
        <span class="text-[10px] mt-1 font-bold uppercase">ç´€éŒ„</span>
      </button>
      <button onclick="switchView('member')" id="nav-member" class="nav-btn">
        <span class="text-2xl">ğŸ‘¤</span>
        <span class="text-[10px] mt-1 font-bold uppercase">æœƒå“¡</span>
      </button>
    </nav>
  </div>

  <script>
    // --- é‡è¦ï¼šAPI è®Šæ•¸åƒ…å®£å‘Šä¸€æ¬¡ï¼Œé¿å… SyntaxError ---
    const API_URL = "https://sport.wetw-net3.workers.dev/";
    let currentUid = "";

    /** åˆå§‹åŒ– LIFF æµç¨‹ */
    async function init() {
      try {
        await liff.init({ liffId: "2008792551-CzPJtVB1" });
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }
        const profile = await liff.getProfile();
        currentUid = profile.userId;
        
        // æ›´æ–° UI ä½¿ç”¨è€…è³‡è¨Š
        const avatarEl = document.getElementById('userAvatar');
        const nameEl = document.getElementById('userNameDisplay');
        if(avatarEl) avatarEl.src = profile.pictureUrl;
        if(nameEl) nameEl.innerText = "æ‚¨å¥½, " + profile.displayName;
        
        // åˆ¤å®šåˆå§‹é¡¯ç¤ºçš„åˆ†é 
        const urlParams = new URLSearchParams(window.location.search);
        const view = urlParams.get('view') || 'index';
        switchView(view);
        
      } catch (err) {
        console.error("LIFF åˆå§‹åŒ–ç•°å¸¸:", err);
        // å¦‚æœæ˜¯åœ¨ç€è¦½å™¨ç›´æ¥æ¸¬è©¦ä¸”ç„¡ LIFFï¼Œé¡¯ç¤ºæ´»å‹•é 
        switchView('index');
      }
    }

    /** æ ¸å¿ƒå°è¦½èˆ‡è³‡æ–™åŠ è¼‰é‚è¼¯ */
    function switchView(v) {
      // 1. åˆ‡æ›ç•«é¢å€å¡Š
      document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
      const targetSection = document.getElementById('view-' + v);
      if(targetSection) targetSection.classList.add('active');

      // 2. åˆ‡æ›å°è¦½æŒ‰éˆ•é¡è‰²
      document.querySelectorAll('nav .nav-btn').forEach(b => b.classList.remove('nav-active'));
      const navKey = v.includes('member') ? 'member' : v;
      const activeNav = document.getElementById('nav-' + navKey);
      if(activeNav) activeNav.classList.add('nav-active');

      // 3. è³‡æ–™åŠ è¼‰è·¯ç”±
      if(v === 'index') loadCourses();
      if(v === 'query') loadHistory();
      if(v === 'member') loadFamily();
      
      window.scrollTo(0,0);
    }

    /** è®€å–é–‹æ”¾å ±åçš„èª²ç¨‹åˆ—è¡¨ */
    async function loadCourses() {
      const container = document.getElementById('courseContainer');
      try {
        const response = await fetch(API_URL, { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'getCourses' }) 
        });
        const res = await response.json();
        const data = res.data || [];
        
        container.innerHTML = data.length ? data.map(c => `
          <div class="course-card p-6 border border-white">
            <span class="bg-green-50 text-green-600 px-2 py-0.5 rounded text-[10px] font-black uppercase">${c.é¡åˆ¥}</span>
            <h3 class="text-lg font-black text-slate-800 mt-2">${c.åç¨±}</h3>
            <p class="text-xs text-slate-400 font-medium mt-1">${c.æ¢¯æ¬¡ || '-'}</p>
            <div class="mt-6 flex justify-between items-center pt-4 border-t border-slate-50">
              <div class="text-[#f43f5e] font-black text-xl italic">$${(Number(c.å…¨æ¢¯æ¬¡ç¸½åƒ¹) || 0).toLocaleString()}</div>
              <button class="bg-green-600 text-white px-6 py-2 rounded-xl text-xs font-black shadow-md active:opacity-80">ç«‹å³å ±å</button>
            </div>
          </div>`).join('') : '<p class="text-center py-20 text-slate-300 font-bold">ç›®å‰å°šç„¡é–‹æ”¾å ±åçš„èª²ç¨‹</p>';
      } catch(e) {
        container.innerHTML = '<p class="text-center py-20 text-red-400 font-bold">ç„¡æ³•é€£ç·š API ä¸­å¿ƒ</p>';
      }
    }

    /** è®€å–ä½¿ç”¨è€…æ­·å²ç´€éŒ„ (å·²ä¿®å¾© loadHistory ç¼ºå¤±å•é¡Œ) */
    async function loadHistory() {
      const container = document.getElementById('historyContainer');
      if(!currentUid) {
        container.innerHTML = '<p class="text-center py-20 text-slate-300 font-bold">è«‹å…ˆå®Œæˆèº«åˆ†é©—è­‰</p>';
        return;
      }
      container.innerHTML = '<div class="text-center py-20"><div class="spinner"></div><p class="text-slate-300 mt-2 font-medium">æŠ“å–ç´€éŒ„ä¸­...</p></div>';
      
      try {
        const response = await fetch(API_URL, { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'getUserRegistrations', userId: currentUid }) 
        });
        const res = await response.json();
        const data = res.data || [];
        
        container.innerHTML = data.length ? data.map(r => `
          <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm">
            <div class="text-[10px] text-green-600 font-black mb-1">${r.æ—¥æœŸ}</div>
            <h4 class="font-black text-slate-800 leading-tight">${r.èª²ç¨‹}</h4>
            <p class="text-[10px] text-slate-400 font-bold mt-2 leading-relaxed">
              å­¸å“¡ï¼š${r.å§“å}<br>è©³æƒ…ï¼š${r.å‡ºå¸­è©³æƒ…}
            </p>
            <div class="mt-4 flex justify-between items-center pt-4 border-t border-slate-50">
              <span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded font-bold">${r.ç‹€æ…‹}</span>
              <span class="text-lg font-black text-slate-800">$${(Number(r.é‡‘é¡) || 0).toLocaleString()}</span>
            </div>
          </div>`).join('') : '<p class="text-center py-20 text-slate-300 font-bold">ç›®å‰å°šç„¡å ±åç´€éŒ„</p>';
      } catch(e) {
        container.innerHTML = '<p class="text-center py-20 text-red-400 font-bold">é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</p>';
      }
    }

    /** è®€å–æˆå“¡åå†Š */
    async function loadFamily() {
      const container = document.getElementById('familyList');
      if(!currentUid) return;
      
      container.innerHTML = '<div class="py-10 text-center text-slate-300 font-bold">è³‡æ–™åŒæ­¥ä¸­...</div>';
      
      try {
        const response = await fetch(API_URL, { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'getFamily', userId: currentUid }) 
        });
        const res = await response.json();
        const data = res.data || [];
        
        container.innerHTML = data.length ? data.map(f => `
          <div class="bg-slate-50 p-5 rounded-2xl flex justify-between items-center border border-white">
            <div>
              <div class="font-black text-slate-800 text-lg">${f.name}</div>
              <div class="text-[10px] text-slate-400 font-bold uppercase tracking-tight">${f.phone} | ${f.relation}</div>
            </div>
            <span class="text-2xl">${f.gender === 'å¥³' ? 'ğŸ‘§' : 'ğŸ‘¦'}</span>
          </div>`).join('') : '<p class="text-center py-20 text-slate-300 font-bold">å°šæœªå»ºç«‹ä»»ä½•æˆå“¡æª”æ¡ˆ</p>';
      } catch(e) {
        container.innerHTML = '<p class="text-center py-20 text-red-400 font-bold">æˆå“¡è³‡æ–™æŠ“å–å¤±æ•—</p>';
      }
    }

    /** é¡¯ç¤ºå­¸å“¡è¡¨å–® */
    function showMemberForm() {
      document.getElementById('memberForm').reset();
      switchView('member-form');
    }

    /** å„²å­˜å­¸å“¡è³‡æ–™ */
    document.getElementById('memberForm').onsubmit = async (e) => {
      e.preventDefault();
      showLoading(true);
      const payload = { 
        action: 'saveFamily', 
        userId: currentUid, 
        name: document.getElementById('mName').value, 
        gender: document.getElementById('mGender').value, 
        phone: document.getElementById('mPhone').value, 
        birthday: document.getElementById('mBirthday').value, 
        relation: document.getElementById('mRelation').value 
      };
      
      try {
        await fetch(API_URL, { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload) 
        });
        showLoading(false);
        alert("å­¸å“¡è³‡æ–™å­˜æª”æˆåŠŸï¼");
        switchView('member');
      } catch (err) {
        showLoading(false);
        alert("è³‡æ–™å‚³é€å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚");
      }
    };

    /** é®ç½©æ§åˆ¶ */
    function showLoading(s) {
      const mask = document.getElementById('loading-mask');
      if(mask) mask.style.display = s ? 'flex' : 'none';
    }

    // ç•¶é é¢è¼‰å…¥å®Œæˆå¾Œå•Ÿå‹• LIFF åˆå§‹åŒ–
    window.onload = init;
  </script>
</body>
</html>
