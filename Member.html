<!--
=====================================================
檔案名稱：Member.html
版本：V6.9.0（完整覆蓋版）
重點：
- 前端不再自行算錢
- 僅顯示後端試算結果
- register 時不送金額
=====================================================
-->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>運動島 Sports Island</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>

<body class="bg-slate-100 min-h-screen flex justify-center">

<div class="w-full max-w-md bg-white min-h-screen flex flex-col">

  <!-- Loading -->
  <div id="loading" class="fixed inset-0 bg-white/90 hidden z-50 flex items-center justify-center">
    <div class="animate-spin w-10 h-10 border-4 border-green-500 border-t-transparent rounded-full"></div>
  </div>

  <main class="flex-grow p-6 space-y-4">

    <h1 class="text-xl font-black">2026 課程報名</h1>

    <div id="courseList" class="space-y-4"></div>

  </main>

</div>

<script>
/* =====================================================
 * 環境判斷（GitHub / GAS / LIFF 共用）
 * ===================================================== */
const API = location.hostname.includes('github')
  ? 'https://你的GAS網址/exec'
  : location.href;

let uid = '';
let courses = [];
let activeCourse = null;
let family = [];

/* =====================================================
 * 初始化
 * ===================================================== */
async function init() {
  showLoading(true);
  await liff.init({ liffId: "2008792551-CzPJtVB1" });
  if (!liff.isLoggedIn()) return liff.login();

  const profile = await liff.getProfile();
  uid = profile.userId;

  await loadCourses();
  showLoading(false);
}

/* =====================================================
 * 課程
 * ===================================================== */
async function loadCourses() {
  const res = await post({ action: 'getCourses' });
  courses = res.data || [];
  document.getElementById('courseList').innerHTML =
    courses.map((c,i)=>`
      <div class="bg-white p-5 rounded-2xl shadow">
        <div class="font-black">${c.名稱}</div>
        <div class="text-sm text-slate-400">${c.開始} ~ ${c.結束}</div>
        <button onclick="openEnroll(${i})"
          class="mt-4 w-full py-3 bg-green-600 text-white rounded-xl font-bold">
          報名
        </button>
      </div>
    `).join('');
}

/* =====================================================
 * 報名（不算錢）
 * ===================================================== */
async function openEnroll(i) {
  activeCourse = courses[i];

  const payload = {
    action: 'register',
    userId: uid,
    name: '測試學員',
    sessionId: activeCourse.id,
    absence: [] // 之後再擴
  };

  const res = await post(payload);

  alert(
    res.success
      ? `報名成功\n金額：$${res.data.paidAmount}`
      : res.msg
  );
}

/* =====================================================
 * 工具
 * ===================================================== */
async function post(body) {
  const r = await fetch(API, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  return r.json();
}

function showLoading(v){
  document.getElementById('loading').style.display = v?'flex':'none';
}

window.onload = init;
</script>

</body>
</html>
