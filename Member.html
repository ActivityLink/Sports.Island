<!-- æª”æ¡ˆåç¨±ï¼šweb/Member.html (V6.7.1 - å°è¦½åˆ‡æ›é‚è¼¯ä¿®å¾©) -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
    :root { --line-green: #06C755; }
    body { background-color: #F4F5F7; font-family: 'Noto Sans TC', sans-serif; color: #334155; margin: 0; }
    .view-section { display: none; }
    .view-section.active { display: block; }
    .nav-active { color: var(--line-green); font-weight: 700; border-top: 3px solid var(--line-green); }
    .absent-row { background-color: #fff1f2; opacity: 0.7; color: #f43f5e; }
  </style>
</head>
<body class="min-h-screen flex justify-center">

  <div class="w-full max-w-md bg-white min-h-screen relative flex flex-col shadow-xl">
    
    <main class="flex-grow pb-32">
      <!-- 1. æ´»å‹•åˆ—è¡¨ -->
      <section id="view-index" class="view-section active">
        <div class="px-6 py-10 border-b border-gray-50 flex justify-between items-center">
          <div>
            <h2 class="text-2xl font-black italic uppercase">Courses</h2>
            <p class="text-green-600 text-[9px] font-bold tracking-widest uppercase mt-1">Enrollment System</p>
          </div>
          <img id="userAvatarSmall" src="" class="w-10 h-10 rounded-full border shadow-sm">
        </div>
        <div id="dynamicCourseContainer" class="p-5 space-y-4">
          <div class="text-center py-20 text-slate-300 font-medium">è¼‰å…¥ä¸­...</div>
        </div>
      </section>

      <!-- 2. å ±åç´€éŒ„ -->
      <section id="view-query" class="view-section">
        <div class="px-6 py-10 border-b bg-white sticky top-0 z-10 shadow-sm">
          <h2 class="text-xl font-bold">æ­·å²å ±åç´€éŒ„</h2>
        </div>
        <div id="historyContainer" class="p-5 space-y-4"></div>
      </section>

      <!-- 3. æœƒå“¡ä¸­å¿ƒ (å­¸å“¡åå†Š) -->
      <section id="view-member" class="view-section">
        <div class="px-8 py-10 border-b bg-white flex justify-between items-center">
          <div>
            <h1 id="userNameDisplay" class="text-2xl font-black">æ‚¨å¥½...</h1>
            <p class="text-xs text-gray-400 mt-1 uppercase tracking-widest">Personal Center</p>
          </div>
          <img id="userAvatar" src="" class="w-14 h-14 rounded-full border shadow-sm">
        </div>
        <div class="p-6">
          <button onclick="showMemberForm()" class="w-full bg-black text-white py-4 rounded-xl font-bold">+ æ–°å¢å­¸å“¡æª”æ¡ˆ</button>
        </div>
        <div id="familyListContainer" class="px-6 space-y-3">
           <p class="text-center py-10 text-gray-300">æ­£åœ¨è®€å–æˆå“¡...</p>
        </div>
      </section>

      <!-- 4. æˆå“¡è¡¨å–® -->
      <section id="view-member-form" class="view-section">
        <div class="px-6 py-10 flex items-center border-b bg-white">
          <button onclick="switchView('member')" class="text-gray-400 font-bold mr-4">â†</button>
          <h2 class="text-lg font-bold">å»ºç«‹å­¸å“¡æª”æ¡ˆ</h2>
        </div>
        <form id="memberForm" class="p-8 space-y-6">
           <input type="text" id="mName" placeholder="å­¸å“¡å§“å" required class="w-full p-4 bg-gray-50 rounded-xl outline-none border focus:border-green-500">
           <div class="grid grid-cols-2 gap-4">
             <select id="mGender" class="p-4 bg-gray-50 rounded-xl outline-none"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select>
             <input type="date" id="mBirthday" required class="p-4 bg-gray-50 rounded-xl outline-none">
           </div>
           <input type="tel" id="mPhone" placeholder="å®¶é•·é›»è©±" required class="w-full p-4 bg-gray-50 rounded-xl outline-none">
           <select id="mRelation" class="w-full p-4 bg-gray-50 rounded-xl outline-none"><option value="æœ¬äºº">æœ¬äºº</option><option value="å­å¥³">å­å¥³</option><option value="å…¶ä»–">å…¶ä»–</option></select>
           <button type="submit" class="w-full bg-green-600 text-white py-5 rounded-2xl font-black shadow-xl">å„²å­˜ä¸¦åŒæ­¥</button>
        </form>
      </section>
    </main>

    <!-- åº•éƒ¨å°è¦½ -->
    <nav class="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-md bg-white/95 backdrop-blur-md border-t px-0 py-2 flex justify-around items-center z-50">
      <button onclick="switchView('index')" id="nav-index" class="flex flex-col items-center nav-active w-1/3 py-2"><span class="text-xl">ğŸ </span><span class="text-[9px] mt-0.5 uppercase font-bold">æ´»å‹•</span></button>
      <button onclick="switchView('query')" id="nav-query" class="flex flex-col items-center text-gray-300 w-1/3 py-2"><span class="text-xl">ğŸ”</span><span class="text-[9px] mt-0.5 uppercase font-bold">ç´€éŒ„</span></button>
      <button onclick="switchView('member')" id="nav-member" class="flex flex-col items-center text-gray-300 w-1/3 py-2"><span class="text-xl">ğŸ‘¤</span><span class="text-[9px] mt-0.5 uppercase font-bold">æœƒå“¡</span></button>
    </nav>
  </div>

  <script>
    let currentUid = "";
    let familyData = [];
    let sessionData = []; 
    const API = "https://sport.wetw-net3.workers.dev/";

    async function init() {
      try {
        await liff.init({ liffId: "2008792551-CzPJtVB1" });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        const profile = await liff.getProfile();
        currentUid = profile.userId;
        document.getElementById('userAvatar').src = profile.pictureUrl;
        document.getElementById('userAvatarSmall').src = profile.pictureUrl;
        document.getElementById('userNameDisplay').innerText = "æ‚¨å¥½, " + profile.displayName;
        loadCourses(); // é è¨­é¦–é 
      } catch (e) { console.error("LIFF Error", e); }
    }

    async function loadCourses() {
      try {
        const res = await fetch(API, { method: 'POST', body: JSON.stringify({ action: 'getCourses' }) }).then(r => r.json());
        sessionData = res.data || [];
        document.getElementById('dynamicCourseContainer').innerHTML = sessionData.map((s, i) => `
          <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm relative group active:scale-[0.98] transition-all">
            <div class="flex justify-between items-start">
              <div class="flex-grow">
                <span class="px-2 py-0.5 bg-gray-100 text-gray-400 text-[9px] font-bold rounded uppercase mb-2">${s.é¡åˆ¥}</span>
                <h3 class="text-lg font-black text-slate-800 leading-tight">${s.åç¨±}</h3>
                <p class="text-xs text-green-600 font-bold mt-1">${s.æ¢¯æ¬¡ || '-'}</p>
              </div>
              <div class="text-right">
                <p class="text-red-500 font-black text-lg">$${Number(s.å…¨æ¢¯æ¬¡ç¸½åƒ¹).toLocaleString()}</p>
              </div>
            </div>
            <div class="mt-6 flex justify-between items-center">
              <div class="text-[10px] text-gray-400 font-bold">${s.é–‹å§‹} ~ ${s.çµæŸ}</div>
              <button class="bg-black text-white px-6 py-2 rounded-lg text-[10px] font-black shadow-md">å ±å</button>
            </div>
          </div>`).join('');
      } catch(e) { console.error(e); }
    }

    async function loadFamily() {
      if(!currentUid) return;
      const res = await fetch(API, { method: 'POST', body: JSON.stringify({ action: 'getFamily', userId: currentUid }) }).then(r => r.json());
      familyData = res.data || [];
      const container = document.getElementById('familyListContainer');
      container.innerHTML = familyData.length ? familyData.map((f, i) => `
        <div class="bg-gray-50 p-5 rounded-2xl flex justify-between items-center border border-white">
          <div><div class="font-black text-black text-lg">${f.name}</div><div class="text-[10px] text-gray-400 font-bold uppercase">${f.phone} | ${f.relation}</div></div>
          <span class="text-2xl">${f.gender === 'å¥³' ? 'ğŸ‘§' : 'ğŸ‘¦'}</span>
        </div>`).join('') : '<p class="text-center py-20 text-gray-300 font-bold">å°šæœªå»ºç«‹ä»»ä½•æˆå“¡è³‡æ–™</p>';
    }

    /** æ ¸å¿ƒä¿®æ­£ï¼šç²¾ç¢ºæ§åˆ¶è¦–åœ–åˆ‡æ›èˆ‡è³‡æ–™è¼‰å…¥ */
    function switchView(v) {
      // 1. éš±è—æ‰€æœ‰å€å¡Š
      document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
      // 2. é¡¯ç¤ºç›®æ¨™å€å¡Š
      const target = document.getElementById('view-' + v);
      if(target) target.classList.add('active');

      // 3. æ›´æ–°å°è¦½æŒ‰éˆ•ç‹€æ…‹
      document.querySelectorAll('nav button').forEach(b => b.classList.remove('nav-active', 'text-green-600', 'text-gray-300'));
      document.querySelectorAll('nav button').forEach(b => b.classList.add('text-gray-300'));
      
      const navKey = v.includes('member') ? 'member' : v;
      const activeNav = document.getElementById('nav-' + navKey);
      if(activeNav) {
        activeNav.classList.add('nav-active', 'text-green-600');
        activeNav.classList.remove('text-gray-300');
      }

      // 4. è³‡æ–™è¼‰å…¥é‚è¼¯ï¼šåš´æ ¼å°æ‡‰æŒ‰éˆ•èˆ‡è¦–åœ–
      if(v === 'index') loadCourses();
      if(v === 'member') loadFamily(); // ç¢ºä¿é»æ“Šã€Œæœƒå“¡ã€ç«‹å³åŸ·è¡Œè®€å–æˆå“¡
      if(v === 'query') loadHistory();
      
      window.scrollTo(0,0);
    }

    function showMemberForm() { document.getElementById('memberForm').reset(); switchView('member-form'); }

    document.getElementById('memberForm').onsubmit = async (e) => {
      e.preventDefault();
      const payload = { action: 'saveFamily', userId: currentUid, name: document.getElementById('mName').value, gender: document.getElementById('mGender').value, phone: document.getElementById('mPhone').value, birthday: document.getElementById('mBirthday').value, relation: document.getElementById('mRelation').value, address: "" };
      await fetch(API, { method: 'POST', body: JSON.stringify(payload) });
      alert("å­˜æª”æˆåŠŸ"); switchView('member');
    };

    window.onload = init;
  </script>
</body>
</html>
