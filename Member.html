<!--
  æª”æ¡ˆåç¨±ï¼šMember.html
  ç‰ˆæœ¬ï¼šV6.8.3ï¼ˆCloudflare Worker æ¨™æº–ç‰ˆï¼‰
  èªªæ˜ï¼š
  - API æ°¸é åªèµ° Worker
  - è§£æ±º ERR_NAME_NOT_RESOLVED <!--
  æª”æ¡ˆåç¨±ï¼šMember.html
  ç‰ˆæœ¬ï¼šV6.9ï¼ˆå®Œæ•´ç‰ˆï¼‰
  æ¶æ§‹ï¼š
  - èª²ç¨‹ / ç´€éŒ„ / æœƒå“¡ ä¸‰å¤§åŠŸèƒ½
  - åº•éƒ¨å°è¦½åˆ—æ°¸é é¡¯ç¤º
  - API ä¸€å¾‹èµ° Cloudflare Worker
-->

<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é‹å‹•å³¶ Sports Island</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont; }
    .view { display: none; }
    .view.active { display: block; }
    .nav-active { color: #06C755; font-weight: 900; }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #06C755;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>

<body class="bg-slate-100 min-h-screen flex justify-center">

<div class="w-full max-w-md bg-white min-h-screen shadow-xl flex flex-col">

  <!-- Header -->
  <header class="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-10">
    <h1 class="text-xl font-black">é‹å‹•å³¶ 2026</h1>
    <div class="w-10 h-10 rounded-full overflow-hidden bg-slate-200">
      <img id="userAvatar" class="w-full h-full object-cover">
    </div>
  </header>

  <!-- Loading -->
  <div id="loading" class="flex-1 flex flex-col items-center justify-center">
    <div class="spinner"></div>
    <p class="mt-4 text-slate-400 font-bold text-sm">ç³»çµ±åˆå§‹åŒ–ä¸­...</p>
  </div>

  <!-- ===================== -->
  <!-- èª²ç¨‹ -->
  <!-- ===================== -->
  <main id="view-index" class="view p-5 space-y-4"></main>

  <!-- ===================== -->
  <!-- ç´€éŒ„ -->
  <!-- ===================== -->
  <main id="view-query" class="view p-5 space-y-4"></main>

  <!-- ===================== -->
  <!-- æœƒå“¡ -->
  <!-- ===================== -->
  <main id="view-member" class="view p-5 space-y-4">
    <button onclick="openMemberForm()"
      class="w-full py-4 bg-black text-white rounded-xl font-bold">
      + æ–°å¢å­¸å“¡
    </button>
    <div id="familyList" class="space-y-3"></div>
  </main>

  <!-- ===================== -->
  <!-- æ–°å¢å­¸å“¡ -->
  <!-- ===================== -->
  <main id="view-member-form" class="view p-5 space-y-4">
    <button onclick="switchView('member')" class="text-slate-400 text-sm">â† è¿”å›</button>

    <input id="mName" placeholder="å­¸å“¡å§“å"
      class="w-full p-4 bg-slate-100 rounded-xl font-bold">

    <input id="mPhone" placeholder="è¯çµ¡é›»è©±"
      class="w-full p-4 bg-slate-100 rounded-xl font-bold">

    <select id="mGender" class="w-full p-4 bg-slate-100 rounded-xl font-bold">
      <option value="ç”·">ç”·</option>
      <option value="å¥³">å¥³</option>
    </select>

    <select id="mRelation" class="w-full p-4 bg-slate-100 rounded-xl font-bold">
      <option value="æœ¬äºº">æœ¬äºº</option>
      <option value="å­å¥³">å­å¥³</option>
    </select>

    <button onclick="saveMember()"
      class="w-full py-4 bg-green-600 text-white rounded-xl font-black">
      å„²å­˜å­¸å“¡
    </button>
  </main>

</div>

<!-- ===================== -->
<!-- åº•éƒ¨å°è¦½ -->
<!-- ===================== -->
<nav class="fixed bottom-0 left-1/2 -translate-x-1/2
            w-full max-w-md bg-white border-t flex justify-around py-2 z-20">

  <button id="nav-index" onclick="switchView('index')" class="nav-active">
    ğŸ <div class="text-xs">èª²ç¨‹</div>
  </button>

  <button id="nav-query" onclick="switchView('query')">
    ğŸ”<div class="text-xs">ç´€éŒ„</div>
  </button>

  <button id="nav-member" onclick="switchView('member')">
    ğŸ‘¤<div class="text-xs">æœƒå“¡</div>
  </button>
</nav>

<script>
/* =====================================================
 * å”¯ä¸€ APIï¼ˆä¿®æ³• Aï¼‰
 * ===================================================== */
const API_URL = "https://sport.wetw-net3.workers.dev/";

/* =====================================================
 * ç‹€æ…‹
 * ===================================================== */
let uid = "";
let courses = [];
let family = [];

/* =====================================================
 * åˆå§‹åŒ–
 * ===================================================== */
async function init() {
  await liff.init({ liffId: "2008792551-CzPJtVB1" });
  if (!liff.isLoggedIn()) return liff.login();

  const p = await liff.getProfile();
  uid = p.userId;
  document.getElementById("userAvatar").src = p.pictureUrl;

  await loadCourses();
  switchView("index");

  document.getElementById("loading").style.display = "none";
}

/* =====================================================
 * View åˆ‡æ›
 * ===================================================== */
function switchView(v) {
  document.querySelectorAll(".view").forEach(e => e.classList.remove("active"));
  document.getElementById("view-" + v).classList.add("active");

  document.querySelectorAll("nav button").forEach(b => b.classList.remove("nav-active"));
  document.getElementById("nav-" + v)?.classList.add("nav-active");

  if (v === "query") loadHistory();
  if (v === "member") loadFamily();
}

/* =====================================================
 * èª²ç¨‹
 * ===================================================== */
async function loadCourses() {
  const r = await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ action: "getCourses" })
  }).then(r => r.json());

  courses = r.data || [];
  const box = document.getElementById("view-index");

  box.innerHTML = courses.map(c => `
    <div class="bg-white rounded-xl p-5 border">
      <div class="font-black">${c.åç¨±}</div>
      <div class="text-xs text-slate-400">${c.é–‹å§‹} ~ ${c.çµæŸ}</div>
      <div class="mt-2 font-black text-red-500">$${c.åƒ¹æ ¼ || 0}</div>
    </div>
  `).join("");
}

/* =====================================================
 * ç´€éŒ„
 * ===================================================== */
async function loadHistory() {
  const r = await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ action: "getUserRegistrations", userId: uid })
  }).then(r => r.json());

  document.getElementById("view-query").innerHTML =
    (r.data || []).map(x => `
      <div class="bg-white p-5 rounded-xl border">
        <div class="text-xs text-slate-400">${x.æ—¥æœŸ}</div>
        <div class="font-black">${x.èª²ç¨‹}</div>
        <div class="font-black text-red-500">$${x.é‡‘é¡}</div>
      </div>
    `).join("") || "å°šç„¡ç´€éŒ„";
}

/* =====================================================
 * æœƒå“¡
 * ===================================================== */
async function loadFamily() {
  const r = await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ action: "getFamily", userId: uid })
  }).then(r => r.json());

  family = r.data || [];
  document.getElementById("familyList").innerHTML =
    family.map(f => `
      <div class="bg-white p-4 rounded-xl border flex justify-between">
        <div>
          <div class="font-black">${f.name}</div>
          <div class="text-xs text-slate-400">${f.relation}</div>
        </div>
        <div>${f.gender === "å¥³" ? "ğŸ‘§" : "ğŸ‘¦"}</div>
      </div>
    `).join("");
}

function openMemberForm() {
  switchView("member-form");
}

async function saveMember() {
  await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "saveFamily",
      userId: uid,
      name: mName.value,
      phone: mPhone.value,
      gender: mGender.value,
      relation: mRelation.value
    })
  });
  switchView("member");
}

window.onload = init;
</script>

</body>
</html>
/ Failed to fetch
-->

<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é‹å‹•å³¶ Sports Island</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- LIFF -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont; }
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #06C755;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>

<body class="bg-slate-100 min-h-screen flex justify-center">

<div class="w-full max-w-md bg-white min-h-screen shadow-xl flex flex-col">

  <!-- Header -->
  <header class="p-6 border-b flex justify-between items-center">
    <h1 class="text-xl font-black">é‹å‹•å³¶ 2026 èª²ç¨‹</h1>
    <div class="w-10 h-10 rounded-full overflow-hidden bg-slate-200">
      <img id="userAvatar" class="w-full h-full object-cover">
    </div>
  </header>

  <!-- Loading -->
  <div id="loading" class="flex-1 flex flex-col items-center justify-center">
    <div class="spinner"></div>
    <p class="mt-4 text-slate-400 font-bold text-sm">ç³»çµ±åˆå§‹åŒ–ä¸­...</p>
  </div>

  <!-- Course List -->
  <main id="courseView" class="hidden p-5 space-y-4"></main>

</div>

<script>
/* =====================================================
 * âœ… å”¯ä¸€æ­£ç¢º API è¨­å®šï¼ˆä¸è¦å†æ”¹ï¼‰
 * ===================================================== */
const API_URL = "https://sport.wetw-net3.workers.dev/";

/* =====================================================
 * ç‹€æ…‹
 * ===================================================== */
let currentUid = "";
let courses = [];

/* =====================================================
 * åˆå§‹åŒ– LIFF
 * ===================================================== */
async function init() {
  try {
    await liff.init({ liffId: "2008792551-CzPJtVB1" });

    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }

    const profile = await liff.getProfile();
    currentUid = profile.userId;
    document.getElementById("userAvatar").src = profile.pictureUrl;

    await loadCourses();

    document.getElementById("loading").classList.add("hidden");
    document.getElementById("courseView").classList.remove("hidden");

  } catch (err) {
    console.error(err);
    alert("LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°é–‹å•Ÿ");
  }
}

/* =====================================================
 * è¼‰å…¥èª²ç¨‹
 * ===================================================== */
async function loadCourses() {
  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ action: "getCourses" })
  }).then(r => r.json());

  courses = res.data || [];
  renderCourses();
}

/* =====================================================
 * é¡¯ç¤ºèª²ç¨‹
 * ===================================================== */
function renderCourses() {
  const container = document.getElementById("courseView");

  if (!courses.length) {
    container.innerHTML = `
      <div class="text-center text-slate-400 font-bold py-20">
        å°šç„¡å¯å ±åèª²ç¨‹
      </div>`;
    return;
  }

  container.innerHTML = courses.map((c, i) => `
    <div class="border rounded-2xl p-6 bg-white">
      <div class="flex justify-between">
        <div>
          <span class="text-xs font-bold text-green-600">${c.é¡åˆ¥}</span>
          <h3 class="text-lg font-black mt-1">${c.åç¨±}</h3>
          <p class="text-xs text-slate-400">${c.æ¢¯æ¬¡ || ""}</p>
        </div>
        <div class="text-right text-red-500 font-black text-xl">
          $${(Number(c.åƒ¹æ ¼) || 0).toLocaleString()}
        </div>
      </div>

      <div class="mt-4 text-xs text-slate-500">
        ğŸ“… ${c.é–‹å§‹} ï½ ${c.çµæŸ}
      </div>

      <button
        onclick="register(${i})"
        class="mt-4 w-full py-3 bg-green-600 text-white rounded-xl font-bold">
        æˆ‘è¦å ±å
      </button>
    </div>
  `).join("");
}

/* =====================================================
 * å ±å
 * ===================================================== */
async function register(idx) {
  const c = courses[idx];

  const payload = {
    action: "register",
    userId: currentUid,
    name: "æ¸¬è©¦å­¸å“¡",
    phone: "0900000000",
    sessionId: c.id
  };

  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  }).then(r => r.json());

  if (res.success) {
    alert("å ±åæˆåŠŸï¼");
  } else {
    alert("å ±åå¤±æ•—ï¼š" + res.msg);
  }
}

/* =====================================================
 * å•Ÿå‹•
 * ===================================================== */
window.onload = init;
</script>

</body>
</html>
