<!--
=====================================================
æª”æ¡ˆåç¨±ï¼šMember.html
ç‰ˆæœ¬ï¼šV6.8.3ï¼ˆä¿®æ³• Aï½œAPI_URL å–®ä¸€å®šç¾©ï¼‰
èªªæ˜ï¼š
- API_URL åƒ…ä½¿ç”¨ window.API_URLï¼Œé¿å…é‡è¤‡å®£å‘Š
- æ­£ç¢ºæ”¯æ´ LIFF redirect / Worker Proxy / GAS
=====================================================
-->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>é‹å‹•å³¶ Sports Island</title>

  <!-- Tailwind CDNï¼ˆç›®å‰éšæ®µå¯æ¥å—ï¼‰ -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; }
    .view { display: none; }
    .view.active { display: block; }
  </style>
</head>

<body class="bg-slate-100 min-h-screen flex justify-center">

<!-- ================================================= -->
<!--  ä¸»å®¹å™¨                                           -->
<!-- ================================================= -->
<div class="w-full max-w-md bg-white min-h-screen relative flex flex-col shadow-xl">

  <!-- Loading -->
  <div id="loading"
       class="fixed inset-0 bg-white/90 z-50 hidden flex-col items-center justify-center">
    <div class="animate-spin w-10 h-10 border-4 border-green-500 border-t-transparent rounded-full"></div>
    <p class="mt-4 text-sm font-bold text-slate-500">è³‡æ–™è¼‰å…¥ä¸­â€¦</p>
  </div>

  <!-- ================================================= -->
  <!--  ä¸»å…§å®¹                                           -->
  <!-- ================================================= -->
  <main class="flex-grow pb-28">

    <!-- ===== æ´»å‹•åˆ—è¡¨ ===== -->
    <section id="view-index" class="view active p-6 space-y-4">
      <h1 class="text-2xl font-black">ğŸ“… èª²ç¨‹æ´»å‹•</h1>
      <div id="courseList" class="space-y-4"></div>
    </section>

    <!-- ===== å ±åç´€éŒ„ ===== -->
    <section id="view-query" class="view p-6 space-y-4">
      <h1 class="text-2xl font-black">ğŸ“– å ±åç´€éŒ„</h1>
      <div id="historyList"></div>
    </section>

    <!-- ===== æœƒå“¡ä¸­å¿ƒ ===== -->
    <section id="view-member" class="view p-6 space-y-4">
      <h1 id="memberTitle" class="text-2xl font-black">æœƒå“¡ä¸­å¿ƒ</h1>
      <button onclick="switchView('member-form')"
              class="w-full py-4 bg-black text-white rounded-xl font-bold">
        + æ–°å¢å­¸å“¡
      </button>
      <div id="familyList" class="space-y-3"></div>
    </section>

    <!-- ===== æ–°å¢å­¸å“¡ ===== -->
    <section id="view-member-form" class="view p-6 space-y-4">
      <button onclick="switchView('member')" class="text-slate-400 font-bold">â† è¿”å›</button>

      <form id="memberForm" class="space-y-4">
        <input id="mName" required placeholder="å­¸å“¡å§“å"
               class="w-full p-4 bg-slate-100 rounded-xl font-bold">
        <select id="mGender" class="w-full p-4 bg-slate-100 rounded-xl font-bold">
          <option value="ç”·">ç”·</option>
          <option value="å¥³">å¥³</option>
        </select>
        <input id="mPhone" required placeholder="è¯çµ¡é›»è©±"
               class="w-full p-4 bg-slate-100 rounded-xl font-bold">
        <input id="mBirthday" type="date" required
               class="w-full p-4 bg-slate-100 rounded-xl font-bold">
        <select id="mRelation" class="w-full p-4 bg-slate-100 rounded-xl font-bold">
          <option value="æœ¬äºº">æœ¬äºº</option>
          <option value="å­å¥³">å­å¥³</option>
        </select>

        <button class="w-full py-4 bg-green-600 text-white rounded-xl font-black">
          å„²å­˜
        </button>
      </form>
    </section>

  </main>

  <!-- ================================================= -->
  <!--  åº•éƒ¨å°è¦½ï¼ˆé—œéµï¼šä¸€å®šè¦å­˜åœ¨ï¼‰                     -->
  <!-- ================================================= -->
  <nav class="fixed bottom-0 left-1/2 -translate-x-1/2
              w-full max-w-md bg-white border-t flex justify-around py-3">

    <button onclick="switchView('index')" class="font-bold">ğŸ <br>æ´»å‹•</button>
    <button onclick="switchView('query')" class="font-bold">ğŸ“–<br>ç´€éŒ„</button>
    <button onclick="switchView('member')" class="font-bold">ğŸ‘¤<br>æœƒå“¡</button>
  </nav>

</div>

<!-- ================================================= -->
<!--  Scriptï¼ˆé‡é»å€ï¼‰                                  -->
<!-- ================================================= -->
<script>
/* =====================================================
 * ä¿®æ³• Aï¼šAPI_URL å–®ä¸€å®šç¾©ï¼ˆçµ•ä¸é‡è¤‡å®£å‘Šï¼‰
 * ===================================================== */
window.API_URL = window.API_URL || "https://sport.wetw-net3.workers.dev/";

/* =====================================================
 * å…¨åŸŸç‹€æ…‹
 * ===================================================== */
let currentUserId = "";
let familyData = [];

/* =====================================================
 * å·¥å…·
 * ===================================================== */
function showLoading(v) {
  document.getElementById('loading').style.display = v ? 'flex' : 'none';
}

function switchView(name) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById('view-' + name).classList.add('active');

  if (name === 'query') loadHistory();
  if (name === 'member') loadFamily();
}

/* =====================================================
 * LIFF åˆå§‹åŒ–
 * ===================================================== */
async function init() {
  showLoading(true);
  try {
    await liff.init({ liffId: "2008792551-CzPJtVB1" });

    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }

    const profile = await liff.getProfile();
    currentUserId = profile.userId;
    document.getElementById('memberTitle').innerText =
      "æ‚¨å¥½ï¼Œ" + profile.displayName;

    await loadCourses();
  } catch (e) {
    alert("LIFF åˆå§‹åŒ–å¤±æ•—");
  }
  showLoading(false);
}

/* =====================================================
 * API å‘¼å«ï¼ˆçµ±ä¸€èµ° Workerï¼‰
 * ===================================================== */
async function post(data) {
  const res = await fetch(window.API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });
  return res.json();
}

/* =====================================================
 * åŠŸèƒ½å€
 * ===================================================== */
async function loadCourses() {
  const box = document.getElementById('courseList');
  const res = await post({ action: "getCourses" });
  const list = res.data || [];

  box.innerHTML = list.map(c => `
    <div class="p-5 bg-slate-50 rounded-xl">
      <div class="font-black">${c.åç¨±}</div>
      <div class="text-sm text-slate-500">${c.é–‹å§‹} ~ ${c.çµæŸ}</div>
      <div class="font-black text-green-600 mt-2">$${c.å…¨æ¢¯æ¬¡ç¸½åƒ¹}</div>
    </div>
  `).join('');
}

async function loadFamily() {
  const box = document.getElementById('familyList');
  const res = await post({ action: "getFamily", userId: currentUserId });
  familyData = res.data || [];

  box.innerHTML = familyData.map(f => `
    <div class="p-4 bg-slate-50 rounded-xl font-bold">
      ${f.name}ï¼ˆ${f.relation}ï¼‰
    </div>
  `).join('');
}

async function loadHistory() {
  const box = document.getElementById('historyList');
  const res = await post({ action: "getUserRegistrations", userId: currentUserId });
  const list = res.data || [];

  box.innerHTML = list.map(r => `
    <div class="p-4 bg-slate-50 rounded-xl">
      <div class="font-black">${r.èª²ç¨‹}</div>
      <div class="text-sm text-slate-500">${r.æ—¥æœŸ}</div>
      <div class="font-black">$${r.é‡‘é¡}</div>
    </div>
  `).join('');
}

/* =====================================================
 * æ–°å¢å­¸å“¡
 * ===================================================== */
document.getElementById('memberForm').onsubmit = async e => {
  e.preventDefault();
  showLoading(true);

  await post({
    action: "saveFamily",
    userId: currentUserId,
    name: mName.value,
    gender: mGender.value,
    phone: mPhone.value,
    birthday: mBirthday.value,
    relation: mRelation.value
  });

  showLoading(false);
  switchView('member');
};

window.onload = init;
</script>

</body>
</html>
