<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>é‹å‹•å³¶ 2026</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body { font-family: system-ui; }
    .modal { display:none; }
    .modal.active { display:flex; }
  </style>
</head>

<body class="bg-slate-50 min-h-screen flex justify-center">

<div class="w-full max-w-md bg-white min-h-screen relative">

  <!-- Header -->
  <div class="flex justify-between items-center p-4 border-b">
    <h1 class="text-xl font-black">é‹å‹•å³¶ 2026</h1>
    <img id="userAvatar" class="w-10 h-10 rounded-full"/>
  </div>

  <!-- Banner -->
  <img src="https://aiwe.cc/wp-content/uploads/2025/12/3486bc19dc6317e16bf4f1449ec52ae4.jpg"
       class="w-full"/>

  <!-- æœƒå“¡åˆ—è¡¨ -->
  <section class="p-4">
    <div class="flex justify-between items-center mb-2">
      <h2 class="font-bold">æœƒå“¡åå–®</h2>
      <button onclick="openAddModal()"
        class="px-3 py-1 bg-green-600 text-white rounded-lg text-sm">
        â• æ–°å¢å®¶äºº
      </button>
    </div>
    <div id="memberList" class="space-y-3"></div>
  </section>

  <!-- åº•éƒ¨å°è¦½ -->
  <nav class="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-md
              bg-white border-t flex justify-around py-2 text-xs">
    <div class="flex flex-col items-center text-slate-400">ğŸ <span>æ´»å‹•</span></div>
    <div class="flex flex-col items-center text-slate-400">ğŸ“„<span>ç´€éŒ„</span></div>
    <div class="flex flex-col items-center text-green-600 font-bold">ğŸ‘¤<span>æœƒå“¡</span></div>
  </nav>

</div>

<!-- Modal -->
<div id="studentModal"
  class="modal fixed inset-0 bg-black/60 items-center justify-center z-50">
  <div class="bg-white w-full max-w-md rounded-xl p-6 space-y-4">

    <h3 id="modalTitle" class="font-black text-lg">æ–°å¢å­¸å“¡</h3>
    <input type="hidden" id="studentId"/>

    <div>
      <label class="text-xs font-bold">æˆå“¡å§“å</label>
      <input id="name" class="w-full p-3 bg-slate-100 rounded-lg"/>
    </div>

    <div>
      <label class="text-xs font-bold">èº«åˆ†åˆ¥</label>
      <select id="identityType" class="w-full p-3 bg-slate-100 rounded-lg"
        onchange="onIdentityChange()">
        <option value="general">ä¸€èˆ¬èº«åˆ†</option>
        <option value="student">å­¸ç”Ÿ</option>
      </select>
    </div>

    <div>
      <label class="text-xs font-bold">ç”Ÿæ—¥</label>
      <input type="date" id="birthday"
        class="w-full p-3 bg-slate-100 rounded-lg"
        onchange="calcAge()"/>
      <p id="ageHint" class="text-xs text-slate-400"></p>
    </div>

    <div>
      <label class="text-xs font-bold">å±…ä½åœ°å€</label>
      <select id="address" class="w-full p-3 bg-slate-100 rounded-lg">
        <option value="">è«‹é¸æ“‡</option>
        <option>ç«¹åŒ—</option>
        <option>æ–°ç«¹å¸‚</option>
        <option>æ¹–å£</option>
        <option>æ–°è±</option>
        <option>å…¶ä»–</option>
      </select>
    </div>

    <div>
      <label class="text-xs font-bold">é—œä¿‚</label>
      <select id="relation" class="w-full p-3 bg-slate-100 rounded-lg">
        <option>æœ¬äºº</option>
        <option>å­å¥³</option>
        <option>å…¶ä»–</option>
      </select>
    </div>

    <div>
      <label class="text-xs font-bold">è¯çµ¡é›»è©±</label>
      <input id="phone" class="w-full p-3 bg-slate-100 rounded-lg"/>
    </div>

    <div class="flex items-center space-x-2">
      <input type="checkbox" id="isDefault"/>
      <label class="text-sm">è¨­ç‚ºé è¨­å ±åè€…</label>
    </div>

    <div class="flex justify-end space-x-2 pt-4">
      <button onclick="closeModal()" class="border px-4 py-2 rounded-lg">å–æ¶ˆ</button>
      <button onclick="saveStudent()" class="bg-green-600 text-white px-4 py-2 rounded-lg">å„²å­˜</button>
    </div>
  </div>
</div>

<script>
const API_URL = "https://sport.wetw-net3.workers.dev/";
let currentUid = "";
let students = [];

async function init() {
  await liff.init({ liffId: "2008792551-CzPJtVB1" });
  if (!liff.isLoggedIn()) return liff.login();

  const p = await liff.getProfile();
  currentUid = p.userId;
  document.getElementById("userAvatar").src = p.pictureUrl;
  loadStudents();
}

async function loadStudents() {
  const res = await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ action:"getFamily", userId:currentUid })
  }).then(r=>r.json());
  students = res.data || [];
  renderList();
}

function renderList() {
  const box = document.getElementById("memberList");
  box.innerHTML = students.map(s => `
    <div class="border rounded-xl p-4 flex justify-between">
      <div>
        <div class="font-bold">${s.name}</div>
        <div class="text-xs text-slate-400">
          ${s.identityType}ï½œ${s.relation}ï½œ${s.address || '-'}
        </div>
      </div>
      <button onclick='editStudent(${JSON.stringify(s)})'
        class="border px-3 py-1 rounded-lg text-sm">ç·¨è¼¯</button>
    </div>
  `).join("");
}

function openAddModal() {
  document.getElementById("studentModal").classList.add("active");
}
function closeModal() {
  document.getElementById("studentModal").classList.remove("active");
}

function editStudent(s) {
  document.getElementById("name").value = s.name || "";
  document.getElementById("identityType").value = s.identityType || "general";
  document.getElementById("birthday").value = s.birthday || "";
  document.getElementById("address").value = s.address || "";
  document.getElementById("relation").value = s.relation || "æœ¬äºº";
  document.getElementById("phone").value = s.phone || "";
  document.getElementById("isDefault").checked = s.isDefault || false;
  calcAge();
  openAddModal();
}

function onIdentityChange() {
  document.getElementById("birthday").required =
    document.getElementById("identityType").value === "student";
}

function calcAge() {
  const b = document.getElementById("birthday").value;
  if (!b) return;
  const age = Math.floor((Date.now() - new Date(b)) / 31557600000);
  document.getElementById("ageHint").innerText = `ç´„ ${age} æ­²`;
}

async function saveStudent() {
  await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({
      action:"saveFamily",
      userId: currentUid,
      name: document.getElementById("name").value,
      identityType: document.getElementById("identityType").value,
      birthday: document.getElementById("birthday").value,
      address: document.getElementById("address").value,
      relation: document.getElementById("relation").value,
      phone: document.getElementById("phone").value,
      isDefault: document.getElementById("isDefault").checked
    })
  });
  closeModal();
  loadStudents();
}

window.onload = init;
</script>

</body>
</html>
