<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>運動島 2026</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
.member-card {
  border:1px solid #e5e7eb;
  border-radius:14px;
  padding:14px;
  cursor:pointer;
}
.member-card:hover { background:#f8fafc }
.modal {
  position:fixed; inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999;
}
.modal.active { display:flex }
</style>
</head>

<body class="bg-slate-100 min-h-screen flex justify-center">

<div class="w-full max-w-md bg-white min-h-screen flex flex-col">

<header class="p-5 border-b flex justify-between items-center">
  <h1 class="font-black text-xl">運動島 2026</h1>
  <img id="userAvatar" class="w-10 h-10 rounded-full bg-slate-200">
</header>

<main class="flex-1 overflow-y-auto p-4 pb-24">
  <h2 class="text-sm font-bold text-slate-400 mb-2">會員名單（點擊可編輯）</h2>
  <div id="familyList" class="space-y-3 text-sm text-slate-400">載入中…</div>
</main>

<nav class="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-md bg-white border-t h-16 flex justify-around items-center">
  <button onclick="loadFamily()">會員</button>
</nav>

</div>

<!-- 編輯會員 Modal -->
<div id="editModal" class="modal">
  <div class="bg-white w-full max-w-sm rounded-2xl p-6 space-y-4">
    <h3 class="font-black text-lg">編輯學員</h3>

    <input id="editName" class="w-full p-3 border rounded-xl" placeholder="姓名">
    <input id="editPhone" class="w-full p-3 border rounded-xl" placeholder="電話">
    <select id="editRelation" class="w-full p-3 border rounded-xl">
      <option>本人</option>
      <option>子女</option>
      <option>其他</option>
    </select>

    <div class="flex space-x-2 pt-2">
      <button onclick="closeModal()" class="flex-1 py-3 bg-slate-200 rounded-xl font-bold">取消</button>
      <button onclick="saveMember()" class="flex-1 py-3 bg-green-600 text-white rounded-xl font-bold">儲存</button>
    </div>
  </div>
</div>

<script>
const API_URL = "https://sport.wetw-net3.workers.dev/";
let currentUid = "";
let familyData = [];
let editingIndex = null;

/* 初始化 */
async function init(){
  await liff.init({ liffId:"2008792551-CzPJtVB1" });
  if(!liff.isLoggedIn()){ liff.login(); return; }
  const p = await liff.getProfile();
  currentUid = p.userId;
  userAvatar.src = p.pictureUrl;
  loadFamily();
}

/* 讀會員 */
async function loadFamily(){
  const box = document.getElementById("familyList");
  box.innerHTML = "載入中…";
  const r = await fetch(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ action:"getFamily", userId:currentUid })
  });
  const j = await r.json();
  familyData = j.data || [];

  box.innerHTML = familyData.map((f,i)=>`
    <div class="member-card" onclick="openEdit(${i})">
      <div class="font-bold">${f.name}</div>
      <div class="text-xs text-slate-400">${f.phone}｜${f.relation}</div>
    </div>
  `).join("") || "尚無學員";
}

/* 開啟編輯 */
function openEdit(i){
  editingIndex = i;
  const f = familyData[i];
  editName.value = f.name;
  editPhone.value = f.phone;
  editRelation.value = f.relation;
  editModal.classList.add("active");
}

/* 關閉 */
function closeModal(){
  editModal.classList.remove("active");
}

/* 儲存 */
async function saveMember(){
  const f = familyData[editingIndex];
  const payload = {
    action:"updateFamily",
    userId:currentUid,
    oldName:f.name,
    oldPhone:f.phone,
    name:editName.value,
    phone:editPhone.value,
    relation:editRelation.value
  };

  const r = await fetch(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(payload)
  });
  const j = await r.json();

  if(j.success){
    closeModal();
    loadFamily();
  } else {
    alert(j.msg || "更新失敗");
  }
}

window.onload = init;
</script>
</body>
</html>
