<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>é‹å‹•å³¶ Sports Island</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body { background:#f4f5f7; }
    .view { display:none; }
    .view.active { display:block; }
    .modal { display:none; }
    .modal.active { display:flex; }
  </style>
</head>

<body class="min-h-screen flex justify-center">

<div class="w-full max-w-md bg-white min-h-screen flex flex-col relative">

  <!-- Header -->
  <header class="p-4 border-b flex justify-between items-center">
    <h1 class="font-black text-lg">é‹å‹•å³¶ 2026</h1>
    <img id="userAvatar" class="w-8 h-8 rounded-full" />
  </header>

  <!-- Main -->
  <main class="flex-grow pb-24">

    <!-- æ´»å‹• -->
    <section id="view-index" class="view active p-4 space-y-4">
      <div id="courseContainer" class="text-center text-slate-400">
        è¼‰å…¥ä¸­â€¦
      </div>
    </section>

    <!-- ç´€éŒ„ -->
    <section id="view-query" class="view p-4 space-y-4">
      <div id="historyContainer" class="text-center text-slate-400">
        å°šç„¡ç´€éŒ„
      </div>
    </section>

    <!-- æœƒå“¡ -->
    <section id="view-member" class="view p-4 space-y-4">
      <h2 id="userName" class="font-black text-lg"></h2>
      <div id="familyList" class="space-y-3"></div>
    </section>

  </main>

  <!-- Bottom Nav -->
  <nav class="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-md bg-white border-t flex justify-around py-2">
    <button onclick="switchView('index')" class="font-bold">ğŸ  æ´»å‹•</button>
    <button onclick="switchView('query')" class="font-bold">ğŸ“„ ç´€éŒ„</button>
    <button onclick="switchView('member')" class="font-bold">ğŸ‘¤ æœƒå“¡</button>
  </nav>

</div>

<!-- å ±å Modal -->
<div id="enrollModal" class="modal fixed inset-0 bg-black/60 items-center justify-center z-50">
  <div class="bg-white w-full max-w-sm rounded-2xl p-6 space-y-5">
    <h3 id="modalTitle" class="font-black text-lg">å ±åç¢ºèª</h3>

    <select id="selectMember" class="w-full p-3 rounded-xl bg-slate-100 font-bold"></select>

    <div class="bg-slate-900 text-white rounded-xl p-4 text-center">
      <div class="text-xs opacity-60 mb-1">æ‡‰ç¹³é‡‘é¡ï¼ˆç”±ç³»çµ±è¨ˆç®—ï¼‰</div>
      <div id="modalPrice" class="text-2xl font-black">$0</div>
    </div>

    <button id="confirmBtn"
      class="w-full bg-green-600 text-white py-3 rounded-xl font-black">
      ç¢ºèªé€å‡º
    </button>

    <button onclick="closeModal()"
      class="w-full py-2 text-slate-400 font-bold">
      å–æ¶ˆ
    </button>
  </div>
</div>

<script>
/* =====================================================
 * å…¨åŸŸè¨­å®šï¼ˆåªæ­¤ä¸€ä»½ï¼‰
 * ===================================================== */
const API_URL = "https://sport.wetw-net3.workers.dev/";
let currentUid = "";
let courseList = [];
let familyData = [];
let activeCourse = null;

/* =====================================================
 * åˆå§‹åŒ–
 * ===================================================== */
async function init() {
  await liff.init({ liffId: "2008792551-CzPJtVB1" });

  if (!liff.isLoggedIn()) {
    liff.login();
    return;
  }

  const profile = await liff.getProfile();
  currentUid = profile.userId;

  document.getElementById("userAvatar").src = profile.pictureUrl;
  document.getElementById("userName").innerText = "æ‚¨å¥½ï¼Œ" + profile.displayName;

  await loadFamily();
  await loadCourses();
}

/* =====================================================
 * View åˆ‡æ›
 * ===================================================== */
function switchView(v) {
  document.querySelectorAll(".view").forEach(el => el.classList.remove("active"));
  document.getElementById("view-" + v).classList.add("active");

  if (v === "query") loadHistory();
}

/* =====================================================
 * èª²ç¨‹
 * ===================================================== */
async function loadCourses() {
  const box = document.getElementById("courseContainer");

  const res = await fetch(API_URL, {
    method:"POST",
    body:JSON.stringify({ action:"getCourses" })
  }).then(r=>r.json());

  courseList = res.data || [];

  box.innerHTML = courseList.map((c,i)=>`
    <div class="p-4 border rounded-xl bg-slate-50">
      <div class="font-black">${c.åç¨±}</div>
      <div class="text-xs text-slate-400">${c.é–‹å§‹} ï½ ${c.çµæŸ}</div>
      <div class="text-green-600 font-black mt-2">
        $${Number(c.åƒ¹æ ¼||0).toLocaleString()}
      </div>
      <button class="mt-3 w-full bg-green-600 text-white py-2 rounded-xl font-bold"
        onclick="openEnroll(${i})">
        å ±å
      </button>
    </div>
  `).join("");
}

/* =====================================================
 * å ±å Modalï¼ˆğŸ”¥ åƒ¹æ ¼ç”±å¾Œç«¯å›å‚³ï¼‰
 * ===================================================== */
function openEnroll(idx){
  if(!familyData.length){
    alert("è«‹å…ˆå»ºç«‹å­¸å“¡è³‡æ–™");
    switchView("member");
    return;
  }

  activeCourse = courseList[idx];
  document.getElementById("modalTitle").innerText = activeCourse.åç¨±;

  document.getElementById("selectMember").innerHTML =
    familyData.map(f=>`<option value="${f.name}|${f.phone}">${f.name}</option>`).join("");

  document.getElementById("modalPrice").innerText = "è¨ˆç®—ä¸­â€¦";
  document.getElementById("enrollModal").classList.add("active");

  // ğŸ”¥ å‘å¾Œç«¯è¦æœ€çµ‚åƒ¹æ ¼
  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"registerPreview",
      courseId: activeCourse.id
    })
  }).then(r=>r.json())
    .then(res=>{
      document.getElementById("modalPrice").innerText =
        "$" + Number(res.finalPrice||0).toLocaleString();
    });

  document.getElementById("confirmBtn").onclick = submitEnroll;
}

function closeModal(){
  document.getElementById("enrollModal").classList.remove("active");
}

/* =====================================================
 * é€å‡ºå ±åï¼ˆğŸ”¥ å®Œå…¨ç”±å¾Œç«¯ç®—åƒ¹ï¼‰
 * ===================================================== */
async function submitEnroll(){
  const [name, phone] =
    document.getElementById("selectMember").value.split("|");

  const res = await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"register",
      userId: currentUid,
      name,
      phone,
      courseId: activeCourse.id
    })
  }).then(r=>r.json());

  if(res.success){
    alert("å ±åæˆåŠŸ\né‡‘é¡ $" + res.data.paidAmount.toLocaleString());
    closeModal();
    switchView("query");
  }else{
    alert("å¤±æ•—ï¼š" + res.msg);
  }
}

/* =====================================================
 * å®¶åº­ & ç´€éŒ„
 * ===================================================== */
async function loadFamily(){
  const res = await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({ action:"getFamily", userId:currentUid })
  }).then(r=>r.json());
  familyData = res.data || [];
}

async function loadHistory(){
  const box = document.getElementById("historyContainer");

  const res = await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({ action:"getUserRegistrations", userId:currentUid })
  }).then(r=>r.json());

  box.innerHTML = (res.data||[]).map(r=>`
    <div class="p-4 border rounded-xl">
      <div class="font-bold">${r.èª²ç¨‹}</div>
      <div class="text-xs text-slate-400">${r.æ—¥æœŸ}</div>
      <div class="font-black">$${Number(r.é‡‘é¡).toLocaleString()}</div>
    </div>
  `).join("") || "å°šç„¡ç´€éŒ„";
}

window.onload = init;
</script>

</body>
</html>
