<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body class="bg-slate-50 min-h-screen pb-24 font-sans">

  <!-- æœƒå“¡å¡ç‰‡ Header -->
  <div class="bg-indigo-600 pt-16 pb-24 px-8 rounded-b-[3.5rem] shadow-lg relative">
    <div class="flex items-center space-x-5">
      <img id="userAvatar" src="https://via.placeholder.com/150" class="w-16 h-16 rounded-2xl border-2 border-white/20 shadow-md object-cover">
      <div>
        <h1 id="userName" class="text-2xl font-black text-white">è¼‰å…¥ä¸­...</h1>
        <p class="text-indigo-200 text-xs font-bold tracking-widest mt-0.5 uppercase">Elite Member</p>
      </div>
    </div>
  </div>

  <!-- åŠŸèƒ½å…§å®¹å€ -->
  <div class="px-6 -mt-12 space-y-6 relative z-10">
    <!-- å ±åè¡¨å–® -->
    <div class="bg-white rounded-[2.5rem] shadow-xl p-8 border border-slate-100">
      <h2 class="font-black text-slate-800 text-lg mb-6 flex items-center">
        <span class="bg-indigo-50 p-2 rounded-xl mr-3">âœï¸</span> è¨»å†Šæ–°èª²ç¨‹
      </h2>
      <form id="regForm" class="space-y-4">
        <div>
          <label class="text-[10px] font-black text-slate-300 uppercase ml-2">å­¸ç”Ÿå§“å</label>
          <input type="text" id="stuName" required class="w-full mt-1 p-4 bg-slate-50 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 border-none">
        </div>
        <div>
          <label class="text-[10px] font-black text-slate-300 uppercase ml-2">è¯çµ¡é›»è©±</label>
          <input type="tel" id="pPhone" required class="w-full mt-1 p-4 bg-slate-50 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 border-none">
        </div>
        <div>
          <label class="text-[10px] font-black text-slate-300 uppercase ml-2">èª²ç¨‹é¸æ“‡</label>
          <select id="cId" class="w-full mt-1 p-4 bg-slate-50 rounded-2xl border-none outline-none appearance-none">
            <option value="S01">è¶³çƒé«”é©—èª² ($600)</option>
            <option value="B01">ç±ƒçƒè¨“ç·´ç‡Ÿ ($2500)</option>
            <option value="C01">äº”æ—¥å¤ä»¤ç‡Ÿ ($8500)</option>
          </select>
        </div>
        <button type="submit" id="subBtn" class="w-full bg-indigo-600 text-white py-5 rounded-3xl font-black text-lg shadow-lg active:scale-95 transition-all mt-4">
          ç¢ºèªè¨»å†Š
        </button>
      </form>
    </div>

    <!-- åº•éƒ¨è³‡è¨Š -->
    <div class="bg-slate-100 p-6 rounded-[2.5rem] text-center">
      <p class="text-xs text-slate-400 font-bold uppercase tracking-widest">é‹å‹•å³¶ Sports Island 2026</p>
    </div>
  </div>

  <!-- åº•éƒ¨å°è¦½åˆ— -->
  <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-white/90 backdrop-blur-md border border-slate-200 px-6 py-3 flex space-x-12 rounded-full shadow-2xl z-50">
    <a href="?p=index" class="flex flex-col items-center text-slate-300 hover:text-indigo-400 transition-colors">
      <span class="text-xl">ğŸ </span>
      <span class="text-[8px] font-black mt-0.5 uppercase">èª²ç¨‹å°ˆå€</span>
    </a>
    <a href="?p=Member" class="flex flex-col items-center text-indigo-600">
      <span class="text-xl">ğŸ‘¤</span>
      <span class="text-[8px] font-black mt-0.5 uppercase">æœƒå“¡ä¸­å¿ƒ</span>
    </a>
  </nav>

  <script>
    let lineUid = "";
    // å–å¾—ç•¶å‰ Worker ä»£ç†ç¶²å€ä½œç‚º API Endpoint
    const API_URL = window.location.href.split('?')[0];

    async function init() {
      try {
        await liff.init({ liffId: "2008792551-CzPJtVB1" });
        
        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        if (!liff.isLoggedIn()) {
          console.log("ç”¨æˆ¶å°šæœªç™»å…¥ï¼Œå¼•å°è‡³ LINE ç™»å…¥é é¢...");
          liff.login();
          return; // é‡è¦ï¼šå¿…é ˆä¸­æ–·åŸ·è¡Œï¼Œç­‰å¾…é é¢è·³è½‰
        }
        
        // åªæœ‰åœ¨ç™»å…¥æˆåŠŸå¾Œæ‰åŸ·è¡Œ API å‘¼å«
        const profile = await liff.getProfile();
        lineUid = profile.userId;
        document.getElementById('userName').innerText = profile.displayName;
        document.getElementById('userAvatar').src = profile.pictureUrl;
        console.log("LIFF åˆå§‹åŒ–æˆåŠŸï¼Œå·²å–å¾—ç”¨æˆ¶è³‡æ–™");
        
      } catch (e) {
        console.error("LIFF åˆå§‹åŒ–æˆ–å–å¾—è³‡æ–™å¤±æ•—:", e);
        // å¦‚æœæ˜¯å› ç‚º Token å¤±æ•ˆå°è‡´çš„éŒ¯èª¤ï¼Œå˜—è©¦é‡æ–°ç™»å…¥
        if (e.message && e.message.includes("access_token")) {
           liff.login();
        }
      }
    }

    document.getElementById('regForm').onsubmit = async function(e) {
      e.preventDefault();
      
      if (!lineUid) {
        alert("å°šæœªå–å¾—ç”¨æˆ¶èº«åˆ†ï¼Œè«‹é‡æ–°æ•´ç†é é¢æˆ–é‡æ–°ç™»å…¥ã€‚");
        return;
      }

      const btn = document.getElementById('subBtn');
      btn.disabled = true;
      btn.innerText = "å‚³é€ä¸­...";

      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'register',
            userId: lineUid,
            name: document.getElementById('stuName').value,
            phone: document.getElementById('pPhone').value,
            courseId: document.getElementById('cId').value
          })
        });
        
        if (!response.ok) throw new Error("ä¼ºæœå™¨å›æ‡‰ç•°å¸¸");
        
        const res = await response.json();
        alert(res.msg);
        if(res.success) document.getElementById('regForm').reset();
      } catch (err) {
        console.error("æäº¤å ±åå¤±æ•—:", err);
        alert("å ±åå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
      } finally {
        btn.disabled = false;
        btn.innerText = "ç¢ºèªè¨»å†Š";
      }
    };

    window.onload = init;
  </script>
</body>
</html>
