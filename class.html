<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>單堂課程 | Sports Island</title>
    
    <!-- LINE LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* 去框化設計 */
        * {
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            color: #000000;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        
        /* 高對比度文字 */
        .text-emphasis {
            color: #000000 !important;
            font-weight: 900 !important;
        }
        
        /* 移除所有陰影和邊框 */
        .no-box {
            box-shadow: none !important;
            border: none !important;
            border-radius: 0 !important;
        }
        
        /* 課程卡片 */
        .course-card {
            border-bottom: 1px solid #e5e7eb !important;
            transition: background-color 0.2s;
        }
        
        .course-card:hover {
            background-color: #f9fafb;
        }
        
        /* 狀態標籤 */
        .status-badge {
            font-weight: 900 !important;
            font-size: 0.75rem !important;
            padding: 2px 8px !important;
            letter-spacing: 0.5px;
        }
        
        .status-available {
            background-color: #dcfce7 !important;
            color: #166534 !important;
        }
        
        .status-full {
            background-color: #fee2e2 !important;
            color: #991b1b !important;
        }
        
        .status-soon {
            background-color: #fef9c3 !important;
            color: #854d0e !important;
        }
        
        /* 價格顯示 */
        .price-original {
            color: #9ca3af !important;
            text-decoration: line-through;
            font-size: 0.875rem;
        }
        
        .price-earlybird {
            color: #dc2626 !important;
            font-size: 1.25rem;
        }
        
        .price-current {
            color: #000000 !important;
            font-size: 1.25rem;
        }
        
        /* 載入動畫 */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #000000;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 篩選器 */
        .filter-chip {
            border: 1px solid #d1d5db;
            padding: 6px 12px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .filter-chip.active {
            background-color: #000000;
            color: #ffffff;
            border-color: #000000;
        }
        
        /* 底部固定按鈕 */
        .fixed-action {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(255,255,255,1) 70%, rgba(255,255,255,0));
            padding: 1rem;
            z-index: 40;
        }
        
        /* 響應式調整 */
        @media (max-width: 640px) {
            .container-padding {
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
            }
        }
    </style>
</head>
<body class="bg-white">
    <div id="app" class="min-h-screen">
        <!-- 導航欄 -->
        <header class="sticky top-0 bg-white border-b border-gray-100 z-30">
            <div class="px-4 py-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <button onclick="history.back()" class="p-2 mr-2">
                            <i data-lucide="arrow-left" class="w-5 h-5 text-black"></i>
                        </button>
                        <h1 class="text-lg font-black text-black">單堂課程</h1>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="filter-btn" class="p-2">
                            <i data-lucide="filter" class="w-5 h-5 text-black"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- 篩選器 -->
        <div id="filter-panel" class="bg-white border-b border-gray-100 px-4 py-3 hidden">
            <div class="space-y-3">
                <!-- 運動類別 -->
                <div>
                    <div class="text-xs font-black text-gray-600 mb-2">運動類別</div>
                    <div class="flex flex-wrap gap-2">
                        <button class="filter-chip sport-filter active" data-sport="">全部</button>
                        <button class="filter-chip sport-filter" data-sport="籃球">籃球</button>
                        <button class="filter-chip sport-filter" data-sport="羽球">羽球</button>
                        <button class="filter-chip sport-filter" data-sport="游泳">游泳</button>
                        <button class="filter-chip sport-filter" data-sport="足球">足球</button>
                        <button class="filter-chip sport-filter" data-sport="體能">體能</button>
                    </div>
                </div>
                
                <!-- 年齡分級 -->
                <div>
                    <div class="text-xs font-black text-gray-600 mb-2">年齡分級</div>
                    <div class="flex flex-wrap gap-2">
                        <button class="filter-chip age-filter active" data-age="">全部</button>
                        <button class="filter-chip age-filter" data-age="幼兒(3-6)">幼兒</button>
                        <button class="filter-chip age-filter" data-age="兒童(7-12)">兒童</button>
                        <button class="filter-chip age-filter" data-age="青少年(13-18)">青少年</button>
                        <button class="filter-chip age-filter" data-age="成人(18+)">成人</button>
                    </div>
                </div>
                
                <!-- 日期篩選 -->
                <div>
                    <div class="text-xs font-black text-gray-600 mb-2">課程日期</div>
                    <div class="flex items-center">
                        <input type="date" id="date-filter" 
                               class="w-full px-3 py-2 border border-gray-300 text-black">
                    </div>
                </div>
                
                <div class="flex space-x-2 pt-2">
                    <button id="reset-filters" class="flex-1 py-2 border border-gray-300 text-black font-black">
                        重置
                    </button>
                    <button id="apply-filters" class="flex-1 py-2 bg-black text-white font-black">
                        套用篩選
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 主要內容 -->
        <main class="pb-20">
            <!-- 載入狀態 -->
            <div id="loading" class="flex flex-col items-center justify-center min-h-[50vh]">
                <div class="loading mb-4"></div>
                <p class="text-black font-medium">載入課程中...</p>
            </div>
            
            <!-- 課程列表 -->
            <div id="course-list" class="hidden">
                <!-- 狀態統計 -->
                <div class="px-4 py-3 bg-gray-50">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-black text-black">
                            <span id="course-count">0</span> 個課程
                        </span>
                        <button id="sort-btn" class="text-sm text-gray-600 flex items-center">
                            <i data-lucide="sort-desc" class="w-4 h-4 mr-1"></i>
                            <span>日期</span>
                        </button>
                    </div>
                </div>
                
                <!-- 課程列表容器 -->
                <div id="courses-container" class="divide-y divide-gray-100">
                    <!-- 課程卡片會動態插入這裡 -->
                </div>
                
                <!-- 空狀態 -->
                <div id="empty-state" class="hidden text-center py-12">
                    <div class="text-gray-300 mb-4">
                        <i data-lucide="calendar-x" class="w-16 h-16 mx-auto"></i>
                    </div>
                    <h3 class="text-lg font-black text-black mb-2">暫無課程</h3>
                    <p class="text-gray-600 mb-6">目前沒有符合條件的課程</p>
                    <button id="reset-search" class="px-4 py-2 bg-black text-white font-black">
                        查看全部課程
                    </button>
                </div>
            </div>
            
            <!-- 錯誤狀態 -->
            <div id="error-state" class="hidden px-4 py-8">
                <div class="text-center">
                    <div class="text-red-600 mb-4">
                        <i data-lucide="alert-circle" class="w-16 h-16 mx-auto"></i>
                    </div>
                    <h3 class="text-lg font-black text-black mb-2">載入失敗</h3>
                    <p id="error-message" class="text-gray-600 mb-4">無法載入課程資訊</p>
                    <button id="retry-load" class="px-4 py-2 bg-black text-white font-black">
                        重新載入
                    </button>
                </div>
            </div>
        </main>
        
        <!-- 底部按鈕 -->
        <div class="fixed-action">
            <div class="px-4">
                <button id="scroll-top" class="w-full py-3 border border-gray-300 text-black font-black mb-2 hidden">
                    <i data-lucide="chevron-up" class="w-4 h-4 inline mr-1"></i>
                    回到頂部
                </button>
                <button onclick="window.location.href='index.html'" class="w-full py-3 bg-black text-white font-black">
                    返回首頁
                </button>
            </div>
        </div>
        
        <!-- 課程詳情彈窗 -->
        <div id="course-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-end md:items-center justify-center p-4">
            <div class="bg-white w-full max-w-2xl max-h-[90vh] overflow-hidden">
                <!-- 模態內容會動態插入 -->
                <div id="modal-content" class="overflow-y-auto max-h-[80vh]"></div>
            </div>
        </div>
        
        <!-- 預約確認彈窗 -->
        <div id="booking-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-md">
                <div class="p-6">
                    <h3 id="booking-title" class="text-lg font-black text-black mb-2"></h3>
                    <p id="booking-message" class="text-black mb-6"></p>
                    <div class="flex space-x-3">
                        <button id="booking-cancel" class="flex-1 py-3 border border-gray-300 text-black font-black">
                            取消
                        </button>
                        <button id="booking-confirm" class="flex-1 py-3 bg-black text-white font-black">
                            確認預約
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 配置
        const CONFIG = {
            LIFF_ID: '2008786875-F7ifLsbN',
            API_BASE_URL: 'https://script.google.com/macros/s/AKfycbxVjW4ZOm_lkwE3X37zzPHz84RjiumyMzFguZcFemcjJEq6wvhXp_5NSSQtAQKEbryD/exec',
            USE_MOCK_DATA: false
        };
        
        // 全局狀態
        let userId = null;
        let userProfile = null;
        let currentCourses = [];
        let currentFilters = {
            sportType: '',
            ageGroup: '',
            courseDate: ''
        };
        let selectedCourse = null;
        
        // ==================== 工具函數 ====================
        
        // 顯示通知
        function showToast(message, type = 'info') {
            // 創建 toast 元素
            const toast = document.createElement('div');
            toast.className = `fixed top-4 left-1/2 transform -translate-x-1/2 px-4 py-3 font-black z-50 ${
                type === 'error' ? 'bg-red-600 text-white' : 
                type === 'success' ? 'bg-green-600 text-white' : 'bg-black text-white'
            }`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // 自動移除
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // 格式化日期
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const options = { month: 'long', day: 'numeric', weekday: 'short' };
            return date.toLocaleDateString('zh-TW', options);
        }
        
        // 格式化時間
        function formatTime(timeStr) {
            return timeStr.substring(0, 5);
        }
        
        // 計算剩餘時間
        function getTimeRemaining(courseDate, startTime) {
            const courseTime = new Date(courseDate + ' ' + startTime);
            const now = new Date();
            const diffMs = courseTime - now;
            
            if (diffMs <= 0) return '已開始';
            
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffDays > 0) {
                return `${diffDays}天後`;
            } else if (diffHours > 0) {
                return `${diffHours}小時後`;
            } else {
                return '即將開始';
            }
        }
        
        // ==================== API 服務 ====================
        
        const api = {
            async request(action, data = {}) {
                try {
                    console.log(`API 請求: ${action}`, data);
                    
                    const response = await fetch(CONFIG.API_BASE_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'User-Id': userId || ''
                        },
                        body: JSON.stringify({
                            ...data,
                            action: action
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const result = await response.json();
                    console.log('API 回應:', result);
                    
                    if (!result.success) {
                        throw new Error(result.error || 'API 請求失敗');
                    }
                    
                    return result.data;
                    
                } catch (error) {
                    console.error('API 請求失敗:', error);
                    
                    // 如果是開發模式，返回模擬數據
                    if (CONFIG.USE_MOCK_DATA) {
                        return this.getMockData(action, data);
                    }
                    
                    throw error;
                }
            },
            
            getMockData(action, data) {
                switch (action) {
                    case 'getCourses':
                        return {
                            courses: [
                                {
                                    courseId: 'C-BASKET-001',
                                    courseName: '兒童籃球體驗課',
                                    sportType: '籃球',
                                    ageGroup: '兒童(7-12)',
                                    difficulty: '體驗級',
                                    courseDate: '2024-01-20',
                                    startTime: '14:30',
                                    endTime: '16:00',
                                    duration: 90,
                                    coachName: '張教練',
                                    venueName: '竹北運動中心籃球場',
                                    venueArea: '竹北',
                                    originalPrice: 800,
                                    earlyBirdPrice: 600,
                                    isEarlyBird: true,
                                    displayPrice: 600,
                                    totalSeats: 15,
                                    enrolledCount: 5,
                                    remainingSeats: 10,
                                    waitlistCapacity: 5,
                                    isAvailable: true,
                                    status: '報名中',
                                    coverImage: 'https://images.unsplash.com/photo-1546519638-68e109498ffc?w=800&auto=format&fit=crop',
                                    highlights: '小班教學,專業教練,安全環境',
                                    description: '適合初學者的籃球基礎課程，學習基本運球、傳球和投籃技巧。'
                                },
                                {
                                    courseId: 'C-BADMINTON-001',
                                    courseName: '青少年羽球基礎班',
                                    sportType: '羽球',
                                    ageGroup: '青少年(13-18)',
                                    difficulty: '初級',
                                    courseDate: '2024-01-22',
                                    startTime: '16:00',
                                    endTime: '17:30',
                                    duration: 90,
                                    coachName: '李教練',
                                    venueName: '竹北羽球館',
                                    venueArea: '竹北',
                                    originalPrice: 1000,
                                    earlyBirdPrice: 800,
                                    isEarlyBird: true,
                                    displayPrice: 800,
                                    totalSeats: 12,
                                    enrolledCount: 8,
                                    remainingSeats: 4,
                                    waitlistCapacity: 3,
                                    isAvailable: true,
                                    status: '報名中',
                                    coverImage: 'https://images.unsplash.com/photo-1552820728-8b83bb6b773f?w=800&auto=format&fit=crop',
                                    highlights: '專業指導,技巧訓練,體能提升',
                                    description: '學習羽球基本技巧，包括握拍、發球、擊球等基礎動作。'
                                }
                            ]
                        };
                    default:
                        return {};
                }
            },
            
            async getCourses(filters = {}) {
                const data = await this.request('getCourses', { filter: filters });
                return data.courses || [];
            },
            
            async getCourse(courseId) {
                const data = await this.request('getCourse', { courseId });
                return data.course;
            },
            
            async getUser() {
                const data = await this.request('getUser');
                return data.user;
            },
            
            async checkRegistration() {
                const data = await this.request('checkRegistration');
                return data;
            },
            
            async createBooking(courseId) {
                const data = await this.request('createBooking', { courseId });
                return data.booking;
            },
            
            async updateUser(userData) {
                const data = await this.request('updateUser', { userData });
                return data;
            }
        };
        
        // ==================== 課程卡片渲染 ====================
        
        function renderCourseCard(course) {
            const statusClass = course.remainingSeats <= 0 ? 'status-full' : 
                               course.remainingSeats <= 3 ? 'status-soon' : 'status-available';
            
            const statusText = course.remainingSeats <= 0 ? '額滿' : 
                              course.remainingSeats <= 3 ? '即將額滿' : '可報名';
            
            const timeRemaining = getTimeRemaining(course.courseDate, course.startTime);
            
            return `
                <div class="course-card px-4 py-4" data-course-id="${course.courseId}">
                    <!-- 課程標題和狀態 -->
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1 pr-2">
                            <h3 class="text-base font-black text-black mb-1">${course.courseName}</h3>
                            <div class="flex items-center flex-wrap gap-2">
                                <span class="text-xs font-black text-black bg-gray-100 px-2 py-1">
                                    ${course.sportType}
                                </span>
                                <span class="text-xs font-black text-black">
                                    ${course.ageGroup}
                                </span>
                                <span class="text-xs font-black text-black">
                                    ${course.difficulty}
                                </span>
                            </div>
                        </div>
                        <span class="status-badge ${statusClass}">
                            ${statusText}
                        </span>
                    </div>
                    
                    <!-- 時間地點 -->
                    <div class="space-y-2 mb-3">
                        <div class="flex items-center text-sm">
                            <i data-lucide="calendar" class="w-4 h-4 text-black mr-2"></i>
                            <span class="font-black text-black">
                                ${formatDate(course.courseDate)} ${formatTime(course.startTime)}-${formatTime(course.endTime)}
                            </span>
                            <span class="text-xs text-gray-600 ml-2">${timeRemaining}</span>
                        </div>
                        <div class="flex items-center text-sm">
                            <i data-lucide="map-pin" class="w-4 h-4 text-black mr-2"></i>
                            <span class="font-black text-black">${course.venueName}</span>
                            <span class="text-xs text-gray-600 ml-2">${course.venueArea}</span>
                        </div>
                        <div class="flex items-center text-sm">
                            <i data-lucide="user" class="w-4 h-4 text-black mr-2"></i>
                            <span class="font-black text-black">${course.coachName}</span>
                        </div>
                    </div>
                    
                    <!-- 名額資訊 -->
                    <div class="flex items-center text-sm mb-3">
                        <i data-lucide="users" class="w-4 h-4 text-black mr-2"></i>
                        <span class="font-black text-black">
                            名額: ${course.enrolledCount}/${course.totalSeats}
                        </span>
                        <span class="text-xs text-gray-600 ml-2">
                            剩餘 ${course.remainingSeats} 名
                        </span>
                        ${course.waitlistCapacity > 0 ? `
                        <span class="text-xs text-yellow-600 ml-2">
                            候補 ${course.waitlistCapacity} 名
                        </span>
                        ` : ''}
                    </div>
                    
                    <!-- 價格和按鈕 -->
                    <div class="flex justify-between items-center pt-3 border-t border-gray-100">
                        <div>
                            ${course.isEarlyBird ? `
                            <div class="flex items-center gap-2">
                                <span class="price-original">${course.originalPrice} PT</span>
                                <span class="price-earlybird">${course.displayPrice} PT</span>
                            </div>
                            ` : `
                            <span class="price-current">${course.displayPrice} PT</span>
                            `}
                        </div>
                        
                        <button class="course-detail-btn px-4 py-2 bg-black text-white text-sm font-black"
                                ${course.remainingSeats <= 0 ? 'disabled' : ''}>
                            ${course.remainingSeats <= 0 ? '已額滿' : '查看詳情'}
                        </button>
                    </div>
                </div>
            `;
        }
        
        // ==================== 課程詳情渲染 ====================
        
        function renderCourseDetail(course) {
            const highlights = course.highlights ? 
                (typeof course.highlights === 'string' ? 
                 course.highlights.split(',').map(h => h.trim()) : 
                 course.highlights) : [];
            
            const detailImages = course.detailImages ? 
                (typeof course.detailImages === 'string' ? 
                 JSON.parse(course.detailImages) : course.detailImages) : [];
            
            return `
                <!-- 模態頭部 -->
                <div class="sticky top-0 bg-white border-b border-gray-100 z-10">
                    <div class="px-4 py-3 flex items-center justify-between">
                        <button onclick="closeModal()" class="p-2">
                            <i data-lucide="x" class="w-5 h-5 text-black"></i>
                        </button>
                        <h2 class="text-lg font-black text-black">課程詳情</h2>
                        <div class="w-10"></div>
                    </div>
                </div>
                
                <!-- 課程內容 -->
                <div class="p-4">
                    <!-- 封面圖片 -->
                    ${course.coverImage ? `
                    <div class="aspect-video bg-gray-100 overflow-hidden rounded-none mb-4">
                        <img src="${course.coverImage}" 
                             alt="${course.courseName}"
                             class="w-full h-full object-cover"
                             loading="lazy">
                    </div>
                    ` : ''}
                    
                    <!-- 課程標題 -->
                    <div class="mb-4">
                        <h1 class="text-xl font-black text-black mb-2">${course.courseName}</h1>
                        <div class="flex items-center flex-wrap gap-2">
                            <span class="text-xs font-black text-black bg-yellow-100 px-2 py-1">
                                ${course.sportType}
                            </span>
                            <span class="text-xs font-black text-black bg-blue-100 px-2 py-1">
                                ${course.ageGroup}
                            </span>
                            <span class="text-xs font-black text-black bg-green-100 px-2 py-1">
                                ${course.difficulty}
                            </span>
                        </div>
                    </div>
                    
                    <!-- 課程亮點 -->
                    ${highlights.length > 0 ? `
                    <div class="mb-4">
                        <h3 class="text-sm font-black text-gray-600 mb-2">課程亮點</h3>
                        <div class="flex flex-wrap gap-2">
                            ${highlights.map(highlight => `
                            <span class="text-xs font-black text-black bg-gray-100 px-3 py-1">
                                ${highlight}
                            </span>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- 基本資訊表格 -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <div class="text-xs font-black text-gray-600 mb-1">教練</div>
                            <div class="text-sm font-black text-black">${course.coachName}</div>
                        </div>
                        <div>
                            <div class="text-xs font-black text-gray-600 mb-1">場地</div>
                            <div class="text-sm font-black text-black">${course.venueName}</div>
                        </div>
                        <div>
                            <div class="text-xs font-black text-gray-600 mb-1">日期</div>
                            <div class="text-sm font-black text-black">${formatDate(course.courseDate)}</div>
                        </div>
                        <div>
                            <div class="text-xs font-black text-gray-600 mb-1">時間</div>
                            <div class="text-sm font-black text-black">${formatTime(course.startTime)}-${formatTime(course.endTime)}</div>
                        </div>
                        <div>
                            <div class="text-xs font-black text-gray-600 mb-1">時長</div>
                            <div class="text-sm font-black text-black">${course.duration} 分鐘</div>
                        </div>
                        <div>
                            <div class="text-xs font-black text-gray-600 mb-1">區域</div>
                            <div class="text-sm font-black text-black">${course.venueArea}</div>
                        </div>
                    </div>
                    
                    <!-- 名額資訊 -->
                    <div class="bg-gray-50 p-4 mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <div>
                                <div class="text-xs font-black text-gray-600 mb-1">名額狀況</div>
                                <div class="text-lg font-black text-black">
                                    ${course.enrolledCount} / ${course.totalSeats}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs font-black text-gray-600 mb-1">剩餘名額</div>
                                <div class="text-lg font-black ${course.remainingSeats <= 3 ? 'text-red-600' : 'text-green-600'}">
                                    ${course.remainingSeats} 名
                                </div>
                            </div>
                        </div>
                        ${course.waitlistCapacity > 0 ? `
                        <div class="text-xs text-yellow-600">
                            候補名額: ${course.waitlistCapacity} 名
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- 價格資訊 -->
                    <div class="bg-gray-50 p-4 mb-4">
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="text-xs font-black text-gray-600 mb-1">費用</div>
                                ${course.isEarlyBird ? `
                                <div class="flex items-center gap-2">
                                    <span class="text-sm text-gray-500 line-through">${course.originalPrice} PT</span>
                                    <span class="text-xl font-black text-red-600">${course.earlyBirdPrice} PT</span>
                                </div>
                                <div class="text-xs text-green-600 mt-1">早鳥優惠中</div>
                                ` : `
                                <div class="text-xl font-black text-black">${course.originalPrice} PT</div>
                                `}
                            </div>
                            ${course.memberPrice ? `
                            <div class="text-right">
                                <div class="text-xs font-black text-gray-600 mb-1">會員價</div>
                                <div class="text-xl font-black text-black">${course.memberPrice} PT</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- 課程描述 -->
                    <div class="mb-6">
                        <h3 class="text-sm font-black text-gray-600 mb-2">課程內容</h3>
                        <div class="text-black leading-relaxed whitespace-pre-line">
                            ${course.description || '暫無課程描述'}
                        </div>
                    </div>
                    
                    <!-- 注意事項 -->
                    ${course.notes ? `
                    <div class="mb-6">
                        <h3 class="text-sm font-black text-gray-600 mb-2">注意事項</h3>
                        <div class="text-black text-sm leading-relaxed">
                            ${course.notes}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- 適合對象 -->
                    ${course.suitableFor ? `
                    <div class="mb-6">
                        <h3 class="text-sm font-black text-gray-600 mb-2">適合對象</h3>
                        <div class="text-black text-sm leading-relaxed">
                            ${course.suitableFor}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- 報名按鈕 -->
                    <div class="sticky bottom-0 bg-white pt-4 pb-2 border-t border-gray-100">
                        <button id="book-course-btn" 
                                class="w-full py-4 text-lg font-black ${course.remainingSeats > 0 ? 'bg-black text-white' : 'bg-gray-300 text-gray-500'}"
                                ${course.remainingSeats <= 0 ? 'disabled' : ''}>
                            ${course.remainingSeats <= 0 ? '已額滿' : '立即預約'}
                        </button>
                        ${course.remainingSeats <= 0 && course.waitlistCapacity > 0 ? `
                        <button id="waitlist-btn" class="w-full py-3 border border-black text-black font-black mt-2">
                            加入候補名單
                        </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        // ==================== 頁面功能 ====================
        
        // 載入課程列表
        async function loadCourses() {
            try {
                showLoading();
                
                const courses = await api.getCourses(currentFilters);
                currentCourses = courses;
                
                updateCourseList(courses);
                updateCourseCount(courses.length);
                
            } catch (error) {
                console.error('載入課程失敗:', error);
                showError('無法載入課程資訊');
            }
        }
        
        // 更新課程列表顯示
        function updateCourseList(courses) {
            const container = document.getElementById('courses-container');
            const emptyState = document.getElementById('empty-state');
            const courseList = document.getElementById('course-list');
            
            if (courses.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                courseList.classList.remove('hidden');
                hideLoading();
                return;
            }
            
            container.innerHTML = courses.map(course => renderCourseCard(course)).join('');
            emptyState.classList.add('hidden');
            courseList.classList.remove('hidden');
            hideLoading();
            
            // 重新初始化圖標
            setTimeout(() => lucide.createIcons(), 100);
            
            // 綁定點擊事件
            bindCourseEvents();
        }
        
        // 更新課程計數
        function updateCourseCount(count) {
            document.getElementById('course-count').textContent = count;
        }
        
        // 顯示載入狀態
        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('course-list').classList.add('hidden');
            document.getElementById('error-state').classList.add('hidden');
        }
        
        // 隱藏載入狀態
        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }
        
        // 顯示錯誤狀態
        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-state').classList.remove('hidden');
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('course-list').classList.add('hidden');
        }
        
        // 打開課程詳情模態
        function openCourseDetail(courseId) {
            const course = currentCourses.find(c => c.courseId === courseId);
            if (!course) return;
            
            selectedCourse = course;
            
            // 獲取完整課程資訊
            api.getCourse(courseId).then(fullCourse => {
                document.getElementById('modal-content').innerHTML = renderCourseDetail(fullCourse);
                document.getElementById('course-modal').classList.remove('hidden');
                
                // 重新初始化圖標
                lucide.createIcons();
                
                // 綁定預約按鈕
                bindBookingEvents(fullCourse);
            }).catch(error => {
                console.error('獲取課程詳情失敗:', error);
                document.getElementById('modal-content').innerHTML = renderCourseDetail(course);
                document.getElementById('course-modal').classList.remove('hidden');
                lucide.createIcons();
                bindBookingEvents(course);
            });
        }
        
        // 關閉模態
        function closeModal() {
            document.getElementById('course-modal').classList.add('hidden');
            selectedCourse = null;
        }
        
        // 顯示預約確認
        function showBookingConfirm(course) {
            const modal = document.getElementById('booking-modal');
            document.getElementById('booking-title').textContent = course.courseName;
            document.getElementById('booking-message').textContent = 
                `確認預約 ${formatDate(course.courseDate)} ${formatTime(course.startTime)} 的課程嗎？`;
            modal.classList.remove('hidden');
        }
        
        // 關閉預約確認
        function closeBookingConfirm() {
            document.getElementById('booking-modal').classList.add('hidden');
        }
        
        // 執行預約
        async function executeBooking() {
            if (!selectedCourse) return;
            
            try {
                closeBookingConfirm();
                
                // 檢查用戶資料完整性
                const regData = await api.checkRegistration();
                if (!regData.isRegistered) {
                    showToast('請先完善個人資料', 'error');
                    
                    // 這裡可以導向註冊頁面
                    setTimeout(() => {
                        window.location.href = 'index.html#profile';
                    }, 1500);
                    return;
                }
                
                // 創建預約
                const booking = await api.createBooking(selectedCourse.courseId);
                
                if (booking.status === 'waitlist') {
                    showToast(`已加入候補名單，目前第${booking.position}位`, 'info');
                } else {
                    showToast('預約成功！', 'success');
                }
                
                // 關閉模態並刷新列表
                closeModal();
                setTimeout(() => loadCourses(), 1000);
                
            } catch (error) {
                console.error('預約失敗:', error);
                showToast(error.message || '預約失敗', 'error');
            }
        }
        
        // ==================== 事件綁定 ====================
        
        // 綁定課程卡片事件
        function bindCourseEvents() {
            document.querySelectorAll('.course-detail-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const courseId = this.closest('.course-card').dataset.courseId;
                    openCourseDetail(courseId);
                });
            });
        }
        
        // 綁定預約按鈕事件
        function bindBookingEvents(course) {
            const bookBtn = document.getElementById('book-course-btn');
            const waitlistBtn = document.getElementById('waitlist-btn');
            
            if (bookBtn) {
                bookBtn.addEventListener('click', () => showBookingConfirm(course));
            }
            
            if (waitlistBtn) {
                waitlistBtn.addEventListener('click', () => showBookingConfirm(course));
            }
        }
        
        // 綁定篩選器事件
        function bindFilterEvents() {
            // 篩選面板切換
            document.getElementById('filter-btn').addEventListener('click', () => {
                const panel = document.getElementById('filter-panel');
                panel.classList.toggle('hidden');
            });
            
            // 運動類別篩選
            document.querySelectorAll('.sport-filter').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('.sport-filter').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');
                });
            });
            
            // 年齡分級篩選
            document.querySelectorAll('.age-filter').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('.age-filter').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');
                });
            });
            
            // 日期篩選
            document.getElementById('date-filter').addEventListener('change', function() {
                currentFilters.courseDate = this.value;
            });
            
            // 套用篩選
            document.getElementById('apply-filters').addEventListener('click', () => {
                // 獲取選中的篩選條件
                const sportFilter = document.querySelector('.sport-filter.active');
                const ageFilter = document.querySelector('.age-filter.active');
                
                currentFilters = {
                    sportType: sportFilter?.dataset.sport || '',
                    ageGroup: ageFilter?.dataset.age || '',
                    courseDate: document.getElementById('date-filter').value || ''
                };
                
                // 關閉篩選面板
                document.getElementById('filter-panel').classList.add('hidden');
                
                // 重新載入課程
                loadCourses();
            });
            
            // 重置篩選
            document.getElementById('reset-filters').addEventListener('click', () => {
                // 重置 UI
                document.querySelectorAll('.filter-chip').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector('.sport-filter[data-sport=""]').classList.add('active');
                document.querySelector('.age-filter[data-age=""]').classList.add('active');
                document.getElementById('date-filter').value = '';
                
                // 重置篩選條件
                currentFilters = {
                    sportType: '',
                    ageGroup: '',
                    courseDate: ''
                };
            });
            
            // 重置搜尋
            document.getElementById('reset-search').addEventListener('click', () => {
                currentFilters = {
                    sportType: '',
                    ageGroup: '',
                    courseDate: ''
                };
                loadCourses();
            });
        }
        
        // 綁定其他事件
        function bindOtherEvents() {
            // 重試載入
            document.getElementById('retry-load').addEventListener('click', loadCourses);
            
            // 回到頂部
            document.getElementById('scroll-top').addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
            
            // 滾動監聽（顯示回到頂部按鈕）
            window.addEventListener('scroll', () => {
                const scrollBtn = document.getElementById('scroll-top');
                if (window.scrollY > 300) {
                    scrollBtn.classList.remove('hidden');
                } else {
                    scrollBtn.classList.add('hidden');
                }
            });
            
            // 預約確認彈窗
            document.getElementById('booking-cancel').addEventListener('click', closeBookingConfirm);
            document.getElementById('booking-confirm').addEventListener('click', executeBooking);
            
            // 點擊模態背景關閉
            document.getElementById('course-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
            
            document.getElementById('booking-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeBookingConfirm();
                }
            });
        }
        
        // ==================== 初始化 ====================
        
        async function initializeApp() {
            try {
                console.log('初始化單堂課程系統...');
                
                // 初始化 LIFF
                await liff.init({ liffId: CONFIG.LIFF_ID });
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                
                const profile = await liff.getProfile();
                userId = profile.userId;
                userProfile = profile;
                
                localStorage.setItem('user_id', userId);
                localStorage.setItem('user_name', profile.displayName);
                
                console.log('用戶已登入:', userId);
                
                // 綁定事件
                bindFilterEvents();
                bindOtherEvents();
                
                // 載入課程
                await loadCourses();
                
                console.log('單堂課程系統初始化完成');
                
            } catch (error) {
                console.error('初始化失敗:', error);
                
                // 如果 LIFF 初始化失敗，仍然可以顯示內容（開發用）
                if (!navigator.userAgent.includes('Line')) {
                    console.log('非 LINE 環境，使用測試模式');
                    userId = 'test-user-' + Date.now();
                    localStorage.setItem('user_id', userId);
                    localStorage.setItem('user_name', '測試用戶');
                    
                    bindFilterEvents();
                    bindOtherEvents();
                    await loadCourses();
                } else {
                    showError('系統初始化失敗，請重新整理');
                }
            }
        }
        
        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof liff !== 'undefined') {
                initializeApp();
            } else {
                setTimeout(() => {
                    if (typeof liff === 'undefined') {
                        console.log('LIFF SDK 載入失敗，使用測試模式');
                        userId = 'test-user-' + Date.now();
                        localStorage.setItem('user_id', userId);
                        localStorage.setItem('user_name', '測試用戶');
                        
                        bindFilterEvents();
                        bindOtherEvents();
                        loadCourses();
                    }
                }, 2000);
            }
        });
        
        // 導出全局函數
        window.closeModal = closeModal;
        window.openCourseDetail = openCourseDetail;
    </script>
</body>
</html>
