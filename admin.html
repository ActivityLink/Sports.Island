<!-- 檔案名稱：admin.html (LINE OA 專業版 V6.7.4 - 版面與費用修復) -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>LINE OA Manager | 運動島管理中心</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
    :root { --line-green: #06C755; --bg-gray: #F4F5F7; --border-color: #E7E9ED; }
    body { background-color: var(--bg-gray); font-family: 'Noto Sans TC', sans-serif; color: #000; margin: 0; font-size: 15px; }
    
    .sidebar { width: 220px; background: #FFF; border-right: 1px solid var(--border-color); height: 100vh; position: fixed; z-index: 50; }
    .sidebar-item { padding: 16px 24px; display: block; width: 100%; text-align: left; font-weight: 500; }
    .sidebar-item.active { background: #F0FBF5; color: var(--line-green); border-right: 4px solid var(--line-green); font-weight: 700; }

    #full-editor { display: none; position: fixed; inset: 0; background: var(--bg-gray); z-index: 1000; overflow-y: auto; }
    #full-editor.active { display: block; }
    
    .spec-card { background: #FFF; border: 1px solid var(--border-color); border-radius: 12px; padding: 40px; margin: 20px auto; max-width: 1000px; }
    .section-title { font-size: 18px; font-weight: 900; margin-bottom: 24px; display: flex; align-items: center; }
    .section-title::before { content: ''; width: 4px; height: 18px; background: var(--line-green); margin-right: 12px; }

    .input-label { font-size: 13px; font-weight: 700; color: #666; margin-bottom: 8px; display: block; }
    .form-input { width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 16px; outline: none; transition: border 0.2s; color: #000; }
    .form-input:focus { border-color: var(--line-green); }

    .btn-primary { background: var(--line-green); color: #FFF; padding: 12px 32px; border-radius: 6px; font-weight: 700; }
    .btn-outline { border: 1px solid var(--line-green); color: var(--line-green); padding: 6px 14px; border-radius: 4px; font-weight: 700; font-size: 13px; }
    
    #loading-mask { position: fixed; inset: 0; background: rgba(255,255,255,0.9); display: none; flex-direction: column; items-center justify-center; z-index: 9999; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--line-green); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    table { width: 100%; border-collapse: collapse; background: #FFF; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; }
    table th { background-color: #FBFBFC; padding: 14px 20px; text-align: left; font-size: 13px; color: #666; border-bottom: 1px solid var(--border-color); }
    table td { padding: 18px 20px; border-bottom: 1px solid var(--border-color); font-weight: 500; }
  </style>
</head>
<body class="flex">

  <div id="loading-mask" class="flex flex-col items-center justify-center">
    <div class="spinner"></div>
    <p class="mt-4 font-bold text-slate-500">正在執行同步工作...</p>
  </div>

  <aside class="sidebar">
    <div class="p-8 border-b font-black text-lg text-green-600 tracking-tighter">SI MANAGER</div>
    <nav class="mt-4">
      <button onclick="switchTab('courses')" id="btn-courses" class="sidebar-item active">課程規格管理</button>
      <button onclick="switchTab('settings')" id="btn-settings" class="sidebar-item">全局參數設定</button>
    </nav>
  </aside>

  <main class="flex-grow ml-[220px] p-10">
    <div class="flex justify-between items-end mb-8">
      <div><h2 class="text-3xl font-black">課程規格清單</h2><p class="text-slate-400 font-medium">請確認各項課程之費用 (J 欄位) 與請假扣除額。</p></div>
      <button onclick="openNewCourse()" class="btn-primary">+ 新增課程規格</button>
    </div>

    <div class="bg-white">
      <table>
        <thead>
          <tr>
            <th class="w-24">編號</th>
            <th class="w-24">類別</th>
            <th>名稱 / 梯次 / 教練</th>
            <th class="w-64">財務與費用設定</th>
            <th class="text-right w-40">管理</th>
          </tr>
        </thead>
        <tbody id="courseTableBody"></tbody>
      </table>
    </div>
  </main>

  <!-- 全螢幕編輯器 -->
  <div id="full-editor">
    <div class="bg-white p-6 border-b flex justify-between items-center sticky top-0 z-10 shadow-sm">
      <h2 class="text-xl font-black">編修課程核心規格</h2>
      <div class="space-x-4">
        <button onclick="closeEditor()" class="px-8 py-2 border rounded font-bold text-slate-400">取消返回</button>
        <button onclick="submitCourseForm()" class="btn-primary">儲存並同步雲端</button>
      </div>
    </div>

    <div class="max-w-5xl mx-auto py-10 px-6 pb-40">
      <!-- 01 基礎 -->
      <div class="spec-card">
        <h3 class="section-title">01 基礎資料</h3>
        <div class="grid grid-cols-4 gap-6">
          <input type="hidden" id="f-id">
          <div class="col-span-1"><label class="input-label">類別</label>
            <select id="f-category" class="form-input">
              <option value="梯次">梯次課程</option><option value="單日">單日課程</option><option value="營隊">營隊專區</option><option value="課後">課後班</option>
            </select>
          </div>
          <div class="col-span-3"><label class="input-label">課程正式全名</label><input type="text" id="f-name" class="form-input font-bold text-lg"></div>
        </div>
        <div class="grid grid-cols-2 gap-6 mt-8">
           <input type="text" id="f-coach" placeholder="負責教練" class="form-input">
           <input type="text" id="f-batch" placeholder="梯次代號 (如：第一梯次)" class="form-input">
        </div>
      </div>

      <!-- 02 財務 (精確校對：J 欄位為課程費用) -->
      <div class="spec-card">
        <h3 class="section-title">02 財務與收費設定 (核心參數)</h3>
        <div class="grid grid-cols-4 gap-6">
          <div><label class="input-label">1. 課程費用 (J 欄)</label><input type="text" id="f-fullPrice" placeholder="5000" class="form-input font-black text-lg border-slate-400"></div>
          <div><label class="input-label">2. 優惠價</label><input type="text" id="f-discountPrice" placeholder="4500" class="form-input font-bold text-blue-600"></div>
          <div><label class="input-label">3. 早鳥價</label><input type="text" id="f-earlyPrice" placeholder="4000" class="form-input font-bold text-green-600"></div>
          <div><label class="input-label text-red-500">4. 請假預扣除金 / 日</label><input type="text" id="f-baseUnit" placeholder="500" class="form-input font-bold text-red-500 border-red-200"></div>
        </div>
        <div class="grid grid-cols-3 gap-6 mt-10 p-6 bg-slate-50 border-2 border-dashed border-slate-200 rounded-xl">
           <div><label class="input-label">早鳥截止日期</label><input type="date" id="f-earlyDeadline" class="form-input"></div>
           <div><label class="input-label">開始日期</label><input type="date" id="f-start" class="form-input"></div>
           <div><label class="input-label">結束日期</label><input type="date" id="f-end" class="form-input"></div>
        </div>
      </div>

      <!-- 03 發布 -->
      <div class="spec-card">
        <h3 class="section-title">03 營運發布詳情</h3>
        <div class="grid grid-cols-2 gap-8">
           <div><label class="input-label">活動封面圖 (HTTPS)</label><input type="text" id="f-img" class="form-input font-mono text-xs" placeholder="https://..."></div>
           <div><label class="input-label">招生狀態</label><select id="f-status" class="form-input font-bold text-green-600"><option value="報名中">報名中</option><option value="已額滿">已額滿</option><option value="停辦">停辦</option></select></div>
        </div>
        <div class="grid grid-cols-2 gap-8 mt-8">
           <textarea id="f-paymentInfo" placeholder="匯款資訊說明" rows="3" class="form-input text-sm"></textarea>
           <textarea id="f-desc" placeholder="詳細說明與攜帶物品" rows="3" class="form-input text-sm"></textarea>
        </div>
        <input type="hidden" id="f-equips" value="[]">
        <input type="hidden" id="f-limit" value="50">
      </div>
    </div>
  </div>

  <script>
    const API = "https://sport.wetw-net3.workers.dev/";
    let courseList = [];

    async function init() {
      showLoading(true);
      try {
        const res = await fetch(API, { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'adminGetData' }) 
        }).then(r => r.json());
        courseList = res.課程 || [];
        render();
      } catch(e) { alert("與伺服器通訊失敗"); }
      finally { showLoading(false); }
    }

    function render() {
      document.getElementById('courseTableBody').innerHTML = courseList.map((c, i) => `
        <tr class="hover:bg-slate-50 transition-all font-medium border-b border-slate-50">
          <td class="p-4 font-mono text-[11px] text-slate-400">${c.id}</td>
          <td class="p-4"><span class="px-2 py-0.5 bg-slate-100 text-slate-500 rounded text-[10px] font-bold">${c.category}</span></td>
          <td class="p-4">
            <div class="font-bold text-black text-base">${c.name}</div>
            <div class="text-[11px] text-slate-400 mt-0.5">${c.coach || '未指定教練'} | ${c.batch || '-'}</div>
          </td>
          <td class="p-4">
            <div class="text-red-500 font-black text-lg">$${(Number(c.fullPrice)||0).toLocaleString()}</div>
            <div class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-0.5">Deduction: $${c.baseUnit}/day</div>
          </td>
          <td class="p-4 text-right space-x-2">
            <button onclick="editCourse(${i})" class="btn-outline">編輯</button>
            <button onclick="cloneCourse(${i})" class="px-4 py-1.5 bg-slate-800 text-white rounded text-xs font-bold">複製</button>
          </td>
        </tr>`).join('');
    }

    function editCourse(idx) { fillForm(courseList[idx]); document.getElementById('full-editor').classList.add('active'); }
    function cloneCourse(idx) { const c = Object.assign({}, courseList[idx]); c.id = "C" + Date.now(); c.name += " (複製)"; fillForm(c); document.getElementById('full-editor').classList.add('active'); }

    function fillForm(c) {
      document.getElementById('f-id').value = c.id || "";
      document.getElementById('f-category').value = c.category || "梯次";
      document.getElementById('f-name').value = c.name || "";
      document.getElementById('f-coach').value = c.coach || "";
      document.getElementById('f-batch').value = c.batch || "";
      // 確保顯示為純數字
      document.getElementById('f-fullPrice').value = c.fullPrice || "";
      document.getElementById('f-discountPrice').value = c.discountPrice || "";
      document.getElementById('f-earlyPrice').value = c.earlyPrice || "";
      document.getElementById('f-baseUnit').value = c.baseUnit || "";
      document.getElementById('f-earlyDeadline').value = c.earlyBirdEnd || "";
      document.getElementById('f-start').value = c.start || "";
      document.getElementById('f-end').value = c.end || "";
      document.getElementById('f-paymentInfo').value = c.paymentInfo || "";
      document.getElementById('f-desc').value = c.desc || "";
      document.getElementById('f-img').value = c.img || "";
      document.getElementById('f-status').value = c.status || "報名中";
      document.getElementById('f-equips').value = c.equips || "[]";
    }

    async function submitCourseForm() {
      showLoading(true);
      const data = {
        action: 'adminSaveCourse',
        id: document.getElementById('f-id').value,
        category: document.getElementById('f-category').value,
        name: document.getElementById('f-name').value,
        coach: document.getElementById('f-coach').value,
        batch: document.getElementById('f-batch').value,
        fullPrice: document.getElementById('f-fullPrice').value,
        discountPrice: document.getElementById('f-discountPrice').value,
        earlyPrice: document.getElementById('f-earlyPrice').value,
        baseUnit: document.getElementById('f-baseUnit').value,
        earlyBirdEnd: document.getElementById('f-earlyDeadline').value,
        start: document.getElementById('f-start').value,
        end: document.getElementById('f-end').value,
        paymentInfo: document.getElementById('f-paymentInfo').value,
        desc: document.getElementById('f-desc').value,
        img: document.getElementById('f-img').value,
        status: document.getElementById('f-status').value,
        equips: document.getElementById('f-equips').value,
        limit: 50
      };
      
      try {
        const res = await fetch(API, { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data) 
        }).then(r => r.json());
        
        if(res.success) {
          alert("儲存成功！費用已更新。");
          init();
          closeEditor();
        } else {
          alert("存檔失敗：" + res.msg);
        }
      } catch(e) { alert("儲存異常，請檢查網路。"); }
      finally { showLoading(false); }
    }

    function openNewCourse() { document.getElementById('f-id').value = "C" + Date.now(); fillForm({}); document.getElementById('full-editor').classList.add('active'); }
    function closeEditor() { document.getElementById('full-editor').classList.remove('active'); }
    function showLoading(s) { document.getElementById('loading-mask').style.display = s ? 'flex' : 'none'; }
    window.onload = init;
  </script>
</body>
</html>
